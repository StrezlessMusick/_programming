<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=koi8-r">
 <META NAME="GENERATOR" CONTENT="SGML-Tools 1.0.9">
 <TITLE> Библиотека языка C GNU glibc: Нелокальные Выходы</TITLE>
 <LINK HREF="glibc-21.html" REL=next>
 <LINK HREF="glibc-19.html" REL=previous>
 <LINK HREF="glibc.html#toc20" REL=contents>
</HEAD>
<body bgcolor="#DDE1C2">
<LINK REL="stylesheet" href="http://www.opennet.ru/opennet4.css" type="text/css">
<!--htdig_noindex-->
<FORM method="get" action="http://www.opennet.ru/search.shtml">
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 WIDTH="100%">
<TR>
<TD VALIGN="BOTTOM" BGCOLOR="#E9EAD6" style="background: #E9EAD6 url('http://www.opennet.ru/back.gif') repeat-x bottom left">
<A HREF="http://www.opennet.ru/"><IMG SRC="http://www.opennet.ru/opennet2.gif" HEIGHT=60 WIDTH=249 ALT="The OpenNET Project" BORDER="0"></A><br>
</TD>

<TD BGCOLOR="#B0B190" WIDTH="1"><IMG SRC="http://www.opennet.ru/p.gif" HEIGHT=1 WIDTH=1 ALT=""></TD>

<TD VALIGN=TOP ALIGN=RIGHT WIDTH="470" HEIGHT="70" BGCOLOR="#D9DAC6">
<TABLE BORDER=0 CELLPADDING=1 WIDTH="470">
<TR>
<TD HEIGHT=60 BGCOLOR="#D9DAC6">

<script async src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
 style="display:inline-block;width:468px;height:60px"
 data-ad-client="ca-pub-2075278885744463"
 data-ad-slot="4070171090"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</TD>
</TR>
</TABLE>
</TD>

<TD BGCOLOR="#B0B190" WIDTH="1"><IMG SRC="http://www.opennet.ru/p.gif" HEIGHT=1 WIDTH=1 ALT=""></TD>
<TD WIDTH="40" BGCOLOR="#E9EAD6" style="background: #E9EAD6 url('http://www.opennet.ru/back.gif') repeat-x bottom left">&nbsp;</TD>
<TD BGCOLOR="#B0B190" WIDTH="1"><IMG SRC="http://www.opennet.ru/p.gif" HEIGHT=1 WIDTH=1 ALT=""></TD>

<TD VALIGN=TOP ALIGN=RIGHT WIDTH="130" BGCOLOR="#E9EAD6" ROWSPAN=3>
<a              
href="http://click.opennet.ru/cgi-bin/opennet/hjump.cgi?lanbilling9" target=_blank><img              
src="http://www.opennet.ru/img/lanbilling9.gif" width=130 height=125 border=0 alt=""></a>

</TD>

</TR>

<TR BGCOLOR="#B0B190"><TD COLSPAN=6><IMG SRC="http://www.opennet.ru/p.gif" HEIGHT=1 WIDTH=1 ALT=""></TD></TR>


<TR BGCOLOR="#E9EAD6">
<TD ALIGN=CENTER COLSPAN=5>
<table width="100%">
<tr>
<td rowspan=2 width=300 nowrap class="h">
<INPUT type=hidden name=exclude value="index|/man.shtml"><A HREF="http://www.opennet.ru/search.shtml" class="h"><u>Поиск</u></A>&nbsp;(<A HREF="http://www.opennet.ru/keywords/" class="h">теги</A>):&nbsp;<INPUT type="text" size="20" name="words" value="" title='для поиска в google наберите "g фраза"'>
</td><td width="20%">
&nbsp;   <A HREF="http://www.opennet.ru/opennews/" class="h"><b><u>НОВОСТИ</u></b></A> (<a href="http://www.opennet.ru/news/opennet.shtml" class="h">+</a>)
</td><td width="20%">
  <A HREF="http://www.opennet.ru/mp/" class="h"><b><u>КОНТЕНТ</u></b></A>
</td><td width="20%">
  <A HREF="http://wiki.opennet.ru" class="h"><b><u>WIKI</u></b></A>
</td><td width="20%">
   <A HREF="http://www.opennet.ru/man.shtml" class="h"><b><u>MAN'ы</u></b></A>
</td><td width="20%">
   <A HREF="http://www.opennet.ru/forum/" class="h"><b><u>ФОРУМ</u></b></A>
</td></tr>
</table>
</TD>
<TD BGCOLOR="#B0B190" WIDTH="1"><IMG SRC="http://www.opennet.ru/p.gif" HEIGHT=1 WIDTH=1 ALT=""></TD>
</TR>
<TR BGCOLOR="#B0B190"><TD COLSPAN=7><IMG SRC="http://www.opennet.ru/p.gif" HEIGHT=2 WIDTH=1 ALT=""></TD></TR>
</TABLE>

<div style="float: left; width: 279; text-align: left;padding-right: 60px;" id=adv><A HREF="http://www.ip-as.ru" target=_blank><IMG SRC="http://www.opennet.ru/img/ipas3.gif" BORDER="0" width="279" height="40"></A></div>
<div style="padding-top: 0px;position:absolute;left:50%;margin-left:-235px;width:470px;" id=adv2>
<script language=JavaScript src="http://www.opennet.ru/cgi-bin/opennet/hints.cgi?itsoft"></script> 
</div>
<div style="width: 279;float: right;" id=adv3>
</div>
<div style="clear: both;"></div>
<br>

<script language="JavaScript"><!--
d=document;a='';r=escape(d.referrer);a+=';r='+r;
js=10; d.write('<img src="http://top.list.ru/counter'+
'?id=77689;js='+js+a+';rand='+Math.random()+
'" alt="" height=1 width=1>');
if(js>11)d.write('<'+'!-- ')//--></script><noscript><img
src="http://top.list.ru/counter?js=na;id=77689"
height=1 width=1 alt="">
</noscript>

</FORM>
<!--/htdig_noindex-->


<table  BORDER=0 CELLSPACING=0 CELLPADDING=0 WIDTH="100%" style="margin-bottom: 5px;margin-top: 5px;">
<tr><td>
<TABLE  BORDER=0 CELLSPACING=0 CELLPADDING=4 BGCOLOR="#E9EAD6" WIDTH="100%">
<TR BGCOLOR="#C7CBB1"><TD><FONT COLOR="#000090">
<b><a href="http://www.opennet.ru/docs/">Каталог документации</a> / 
<a href="http://www.opennet.ru/docs/124.shtml">Раздел "Программирование, языки"</a> /
<a href="index.html">Оглавление документа</a>
</b>
</TD></TR>
</TABLE>
</TD></TR>
<TR BGCOLOR="#B0B190"><TD><IMG SRC="http://www.opennet.ru/p.gif" HEIGHT=3 WIDTH=1 ALT=""></TD></TR>
</TABLE>

<A HREF="glibc-21.html">Вперед</A>
<A HREF="glibc-19.html">Назад</A>
<A HREF="glibc.html#toc20">Содержание</A>
<HR>
<H2><A NAME="s20">20. Нелокальные Выходы</A></H2>

<P>
<P>
<P>Иногда, когда ваша программа обнаруживает необычную ситуацию
внутри глубоко вложенного набора обращений к функциям, Вы можете захотеть
немедленно возвратиться к внешнему уровню управления. Этот раздел
описывает, как делать такие нелокальные выходы,
используя setjmp и longjmp функции.
<P>
<H2><A NAME="ss20.1">20.1 Введение в нелокальные Выходы</A>
</H2>

<P>
<P>Вот пример ситуации, где нелокальный выход может быть полезен:
предположим, Вы имеете интерактивную программу, которая имеет "основной цикл" 
который запрашивает и выполняет команды.
Предположите, что команда "read" читает ввод из файла, делая
некоторый лексический анализ и анализируя ввод. Если входная ошибка
низкого уровня обнаружена, то было бы полезно возвратиться
немедленно в " основной цикл " вместо того, чтобы иметь
необходимость делать лексический анализ, синтаксический анализ, и
все фазы обработки, которые должны явно иметь дело с ситуациями
ошибки, первоначально обнаруженными вложенными обращениями.
<P>Некоторым образом нелокальный выход подобен использованию
"return", чтобы возвратиться из функции. Но в то время как "return"
отказывается только от обращения, пересылая управление обратно к
функции, из которой оно вызывалось, нелокальный выход может
потенциально отказываться от многих уровней вложенных обращений к
функциям.
<P>Вы определяете куда возвращать управление при нелокальных выходах,
вызывая функцию setjmp. Эта функция сохраняет информацию
относительно среды выполнения, в которой появляется обращение к
setjmp в объекте типа jmp_buf. После обращения к setjmp выполнение
программы продолжается как обычно, но если позже вызывается
longjmp с соответствующим объектом jmp_buf, управление передается
обратно в то место, где вызывалась setjmp. Возвращаемое значение из
setjmp используется, чтобы отличить обычный возврат и возврат,
сделанный обращением к longjmp, так что обращения к setjmp обычно
появляются в ` if '.
<P>Вот пример программы, описанный выше:
<BLOCKQUOTE><CODE>
<PRE>
                 #include &lt;setjmp.h&gt;
                 #include &lt;stdlib.h&gt;
                 #include &lt;stdio.h&gt;
                 jmp_buf main_loop;
                 void
                 abort_to_main_loop (int status)
                 {
                         longjmp (main_loop, status);
                 }
                 int
                 main (void)
                 {
                         while (1)
                                 if (setjmp (main_loop))
                                         puts ("Back at main loop....");
                                 else
                                         do_command ();
                 }

                 void
                         do_command (void)
                         {
                                 char buffer[128];
                                 if (fgets (buffer, 128, stdin) == NULL)
                                         abort_to_main_loop (-1);
                                 else
                                         exit (EXIT_SUCCESS);
                         }
</PRE>
</CODE></BLOCKQUOTE>

Функция abort_to_main_loop вызывает непосредственную передачу
управления в main программы, независимо от того, где она
вызывается.
<P>Способ управления внутри функции main может показаться сначала немного
таинственным, но это - фактически общая идиома для setjmp.
Нормальное обращение к setjmp возвращает нуль, так что "else"-часть
условного выражения выполнена. Если abort_to_main_loop вызывается
где-нибудь внутри выполнения команды do, то это фактически
действует как будто обращение к setjmp в main возвращалось со
значением -1.
<P>Так, общий шаблон для использования setjmp выглядит вроде:
<BLOCKQUOTE><CODE>
<PRE>
                         if (setjmp (buffer))
                                 /* Код, для выполнения после
          преждевременного возврата. */
                                 . . .
                         else
                                 /* Код, который будет
         выполнен после обычной установки
         возвращающей отметки. */
                                 . . .
</PRE>
</CODE></BLOCKQUOTE>
<H2><A NAME="ss20.2">20.2 Подробности нелокальных Выходов</A>
</H2>

<P>
<P>Имеются некоторые подробности относительно функций и структур
данных, используемых для выполнения нелокальных выходов.
<P>Эти средства объявлены в " setjmp.h ".
<BLOCKQUOTE><CODE>
<PRE>
       jmp_buf  (тип данных)
</PRE>
</CODE></BLOCKQUOTE>

Объекты типа jmp_buf содержат информацию о состоянии, которое
будет восстановлено при нелокальном выходе.
<P>Содержимое jmp_buf идентифицирует конкретное место
возвращения.
<P>
<BLOCKQUOTE><CODE>
<PRE>
       int setjmp (jmp_buf state)  (макрос)
</PRE>
</CODE></BLOCKQUOTE>
       setjmp сохраняет информацию относительно состояния выполнения
программы в state и возвращает нуль. Если longjmp позже
используется, чтобы выполнить нелокальный выход к этому состоянию,
setjmp возвращает значение отличное от нуля.
<BLOCKQUOTE><CODE>
<PRE>
       void longjmp (jmp_buf state, int value) 
</PRE>
</CODE></BLOCKQUOTE>

Эта функция восстанавливает текущее выполнение в состояние,
сохраненное в state, и продолжает выполнение от обращения к setjmp.
Возвращение из setjmp посредством longjmp возвращает значение
аргумента, который был передан к longjmp, а не 0. (Но если значение
задано как 0, setjmp возвращает 1).
<P>Имеется множество неизвестных, но важных ограничений на
использование setjmp и longjmp. Большинство этих ограничений
присутствует, потому что нелокальные выходы требуют некоторых
волшебных свойств от части компилятора Cи и могут взаимодействовать
с другими частями языка странными способами.
setjmp - фактически макрокоманда без определения функции, так что
Вы не должны пробовать к " #undef " ее или брать адрес. Кроме того,
обращения к setjmp безопасны в только следующих контекстах:
<UL>
<LI>        Как тестовое выражение в операторе выбора или цикла (типа "if"
или "while").</LI>
<LI>        Как один операнд равенства или сравнения, которое появляется
как тестовое выражение оператора выбора или цикла. Другой операнд
должен быть целочисленным постоянным выражением.</LI>
<LI>        Как операнд унарного оператора "!", который появляется как как
тестовое выражение оператора выбора или цикла.</LI>
<LI>        Как выражение утверждения.</LI>
</UL>

Пункты возврата, допустимы только в течение динамической
протяженности функции которая вызвала setjmp, установить их. Если
Вы используете longjmp чтобы возвратиться отметке, которая была
установлена в функции, которая уже возвратилась, могут случиться
непредсказуемые и бедственные вещи.
<P>Вы должны использовать в longjmp аргумент отличный от нуля. То
что longjmp отказывается передавать обратно аргумент нуля как
возвращаемое значение из setjmp, предназначено для
безопасности при случайном неправильном употреблении и не
является хорошим стилем программирования.
<P>
<P>Когда Вы выполняете нелокальный выход, все доступные объекты
сохраняют любые значения, которые они имели во время вызова
longjmp. Исключение - значения динамических локальных переменных,
локальных для функции, содержащей обращение к setjmp, будут
изменены и начиная с обращения на setjmp являются неопределенными,
если Вы не объявили их отдельно.
<P>
<H2><A NAME="ss20.3">20.3 Нелокальные Выходы и Сигналы</A>
</H2>

<P>
<P>В системах UNIX BSD, setjmp и longjmp также сохраняют и
восстанавливают набор блокированных сигналов; см. Раздел 21.7
[Блокирование Сигналов]. Однако, POSIX.1 стандарт требует чтобы
setjmp и longjmp не изменяли набор блокированных сигналов, и
обеспечивает дополнительную пару функций (sigsetjmp и sigsetjmp)
чтобы получить поведение BSD функций.
<P>Поведение setjmp и longjmp в библиотеке GNU управляется
макрокомандами теста возможностей; см. Раздел 1.3.4 [Макрокоманды
Проверки Возможностей]. Значение по умолчанию в системе GNU &shy;
POSIX.1 поведение, а не поведение BSD.
<P>Средства в этом разделе объявлены в заглавном файле " setjmp.h ".
<BLOCKQUOTE><CODE>
<PRE>
       sigjmp_buf  (тип данных)
</PRE>
</CODE></BLOCKQUOTE>

Подобен jmp_buf, за исключением того, что он может также
сохранять информацию о состоянии набора блокированных сигналов.
<BLOCKQUOTE><CODE>
<PRE>
       int sigsetjmp (sigjmp_buf state, int savesigs)  (функция)
</PRE>
</CODE></BLOCKQUOTE>

Подобна setjmp. Если savesigs отличен от нуля, набор
блокированных сигналов сохранен в state и будет восстановлен, если
siglongjmp позже будет выполнена с этим state.
<BLOCKQUOTE><CODE>
<PRE>
       void siglongjmp (sigjmp_buf state, int value)  (функция)
</PRE>
</CODE></BLOCKQUOTE>

Подобна longjmp кроме типа аргумента state. Если обращение к
sigsetjmp, которое устанавило это состояние, использовало savesigs
флаг отличный от нуля, siglongjmp также восстанавливает набор
блокированных сигналов.
<P>
<P>
<P>
<P>
<P>
<P>
<HR>
<A HREF="glibc-21.html">Вперед</A>
<A HREF="glibc-19.html">Назад</A>
<A HREF="glibc.html#toc20">Содержание</A>

<!--htdig_noindex-->
<noindex>
<br>

<table id=ibm_adv align=center><tr valign=top><td width="605">
<iframe src="http://www.opennet.ru/adv_lc.html" height="240" width="605" scrolling="no" name="ibm" border="0" frameborder="0" target="_blank" marginheight="0" marginwidth="0"></iframe>
</td></tr></table>
</noindex>
<!--/htdig_noindex-->


<!-- footer -->
<!--htdig_noindex-->
<br>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=1 WIDTH="100%" BGCOLOR="#B0B190">
<TR><TD>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 WIDTH="100%" VALIGN="MIDDLE">
<TR>
<TD WIDTH="35%" BGCOLOR="#E9EAD6" ALIGN=LEFT>
<FONT SIZE="-1">
&nbsp;&nbsp;<A HREF="http://www.opennet.ru/cgi-bin/opennet/bookmark.cgi">Закладки&nbsp;на&nbsp;сайте</A><BR>
&nbsp;&nbsp;<A HREF="http://www.opennet.ru/cgi-bin/opennet/bookmark.cgi?submit=add" target="blank_">Проследить&nbsp;за&nbsp;страницей</A>
</FONT>
</TD>
<TD WIDTH="65%" ALIGN=RIGHT BGCOLOR="#E9EAD6">
<FONT SIZE="-1">Created&nbsp;1996-2014&nbsp;by&nbsp;<B><A HREF="http://www.opennet.ru/contact.shtml" title="email mc@tyumen.ru">Maxim&nbsp;Chirkov</A></B></FONT>&nbsp;&nbsp;<BR>
<FONT SIZE="-1"><A HREF="http://www.opennet.ru/add.shtml">Добавить</A>,&nbsp;<A HREF="http://www.opennet.ru/reklama.shtml">Реклама</A>,&nbsp;<A HREF="http://www.opennet.ru/banners2.shtml">Вебмастеру</A>,&nbsp;<A HREF="http://www.opennet.ru/guide.shtml">ГИД</A></FONT>&nbsp;&nbsp;
</TD>
</TR>
</TABLE>
</TD></TR>
</TABLE>


<div align=right><table><tr><td>
<a target=_blank href="http://www.runnet.ru"><img src="http://www.opennet.ru/img/runnet.gif" border=0 height=31 width=88 alt="RUNNet"></a>
<a target=_blank href="http://top.list.ru/jump?from=77689"><img src="http://top.list.ru/counter?id=77689;t=75;l=1" border=0 height=31 width=38 alt="TopList"></a>
<script type="text/javascript"><!--
document.write("<a href='http://www.liveinternet.ru/click' "+
"target=_blank><img src='//counter.yadro.ru/hit?t45.6;r"+
escape(document.referrer)+((typeof(screen)=="undefined")?"":
";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
";"+Math.random()+
"' alt='' title='LiveInternet' "+
"border='0' width='31' height='31'><\/a>")
//--></script>
<a target=_blank href="http://counter.rambler.ru/top100/"><img src="http://counter.rambler.ru/top100.cnt?10566" width=1 height=1 border=0><img src="http://www.opennet.ru/banner.gif" width=88 height=31 border=0></a>
</td></tr></table>
</div>
</form>
<!--/htdig_noindex-->
<!-- end of footer -->

</BODY>
</HTML>
