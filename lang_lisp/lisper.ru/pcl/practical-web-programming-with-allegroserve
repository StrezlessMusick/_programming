<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ru" xml:lang="ru"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <meta name="keywords" content="Common Lisp,lisp,лисп" /> <title>Практика. Web-программирование с помощью AllegroServe</title> <link href="../css/style.css" rel="stylesheet" type="text/css" /><link href="../css/colorize.css" rel="stylesheet" type="text/css" />  </head> <body> <div class="top"> <div id="login"> <a href="http://lisper.ru/register">Регистрация</a> | <a href="http://lisper.ru/login?done=/pcl/practical-web-programming-with-allegroserve">Войти</a> </div> </div> <div id="caution"> <img alt="Lisp — программируемый язык программирования" src="../image/gecko.png" /> <a href="http://www.vkusnoserver.ru/" target="_blank" style="float: right;"> <img src="../vkusnoserver.png" /> </a> </div> <div id="mainmenu"> <ul> <li> <a href="http://lisper.ru/">Главная</a> </li><li> <a href="http://lisper.ru/articles/">Статьи</a> </li><li> <a href="http://lisper.ru/planet/">Планета</a> </li><li> <a href="http://lisper.ru/forum/">Форум</a> </li><li> <a href="http://lisper.ru/apps/">Сервисы</a> </li><li> <a href="index.html">Practical Common Lisp</a> </li><li> <a href="http://lisper.ru/wiki/">Wiki</a> </li><li> <a href="http://lisper.ru/files/">Файлы</a> </li><li> <a href="http://lisper.ru/search">Поиск</a> </li> </ul> </div> <div id="content"> <table width="100%"> <tbody> <tr> <td width="20%" align="left"> <a href="practical-an-id3-parser">Предыдущая</a> </td> <td width="60%" align="center"> <a href="index.html">Оглавление</a> </td> <td width="20%" align="right"> <a href="practical-an-mp3-database">Следующая</a> </td> </tr> </tbody> </table> <div class="article"><div class="toc"><div class="toc-header">Содержание</div><div class="toc-body"><ul><li><div><a href="practical-web-programming-with-allegroserve#26. &#x41F;&#x440;&#x430;&#x43A;&#x442;&#x438;&#x43A;&#x430;. Web-&#x43F;&#x440;&#x43E;&#x433;&#x440;&#x430;&#x43C;&#x43C;&#x438;&#x440;&#x43E;&#x432;&#x430;&#x43D;&#x438;&#x435; &#x441; &#x43F;&#x43E;&#x43C;&#x43E;&#x449;&#x44C;&#x44E; AllegroServe">26. Практика. Web-программирование с помощью AllegroServe</a><ul><li><div><a href="practical-web-programming-with-allegroserve#30-&#x441;&#x435;&#x43A;&#x443;&#x43D;&#x434;&#x43D;&#x43E;&#x435; &#x432;&#x432;&#x435;&#x434;&#x435;&#x43D;&#x438;&#x435; &#x432; Web-&#x43F;&#x440;&#x43E;&#x433;&#x440;&#x430;&#x43C;&#x43C;&#x438;&#x440;&#x43E;&#x432;&#x430;&#x43D;&#x438;&#x435; &#x43D;&#x430; &#x441;&#x442;&#x43E;&#x440;&#x43E;&#x43D;&#x435; &#x441;&#x435;&#x440;&#x432;&#x435;&#x440;&#x430;">30-секундное введение в Web-программирование на стороне сервера</a></div></li><li><div><a href="practical-web-programming-with-allegroserve#AllegroServe">AllegroServe</a></div></li><li><div><a href="practical-web-programming-with-allegroserve#&#x413;&#x435;&#x43D;&#x435;&#x440;&#x438;&#x440;&#x43E;&#x432;&#x430;&#x43D;&#x438;&#x435; &#x434;&#x438;&#x43D;&#x430;&#x43C;&#x438;&#x447;&#x435;&#x441;&#x43A;&#x43E;&#x433;&#x43E; &#x441;&#x43E;&#x434;&#x435;&#x440;&#x436;&#x438;&#x43C;&#x43E;&#x433;&#x43E; &#x441; &#x43F;&#x43E;&#x43C;&#x43E;&#x449;&#x44C;&#x44E; AllegroServe">Генерирование динамического содержимого с помощью AllegroServe</a></div></li><li><div><a href="practical-web-programming-with-allegroserve#&#x413;&#x435;&#x43D;&#x435;&#x440;&#x438;&#x440;&#x43E;&#x432;&#x430;&#x43D;&#x438;&#x435; HTML">Генерирование HTML</a></div></li><li><div><a href="practical-web-programming-with-allegroserve#&#x41C;&#x430;&#x43A;&#x440;&#x43E;&#x441;&#x44B; HTML">Макросы HTML</a></div></li><li><div><a href="practical-web-programming-with-allegroserve#&#x41F;&#x430;&#x440;&#x430;&#x43C;&#x435;&#x442;&#x440;&#x44B; &#x437;&#x430;&#x43F;&#x440;&#x43E;&#x441;&#x430;">Параметры запроса</a></div></li><li><div><a href="practical-web-programming-with-allegroserve#Cookies">Cookies</a></div></li><li><div><a href="practical-web-programming-with-allegroserve#&#x41D;&#x435;&#x431;&#x43E;&#x43B;&#x44C;&#x448;&#x43E;&#x439; &#x43A;&#x430;&#x440;&#x43A;&#x430;&#x441; &#x43F;&#x440;&#x438;&#x43B;&#x43E;&#x436;&#x435;&#x43D;&#x438;&#x439;">Небольшой каркас приложений</a></div></li><li><div><a href="practical-web-programming-with-allegroserve#&#x420;&#x435;&#x430;&#x43B;&#x438;&#x437;&#x430;&#x446;&#x438;&#x44F;">Реализация</a></div></li></ul></div></li></ul></div></div>
<div class="chapter" id="26. &#x41F;&#x440;&#x430;&#x43A;&#x442;&#x438;&#x43A;&#x430;. Web-&#x43F;&#x440;&#x43E;&#x433;&#x440;&#x430;&#x43C;&#x43C;&#x438;&#x440;&#x43E;&#x432;&#x430;&#x43D;&#x438;&#x435; &#x441; &#x43F;&#x43E;&#x43C;&#x43E;&#x449;&#x44C;&#x44E; AllegroServe"><h3>26. Практика. Web-программирование с помощью AllegroServe</h3>

<p>В этой главе вы ознакомитесь с одним из способов разработки Web-приложений на Common Lisp: используя AllegroServe – Web-сервер с открытым исходным кодом. Это не означает, что вы найдете здесь исчерпывающее введение в AllegroServe. И я определенно не собираюсь описывать ничего более чем небольшую часть огромной темы Web-программирования. Моей целью является описание достаточного количества базовых вещей по части использования AllegroServe, которые позволят нам в главе 29 разработать приложение для просмотра библиотеки MP3-файлов и проигрывания их на MP3-клиенте. Кроме того, данная глава может служить кратким введением в Web-программирование для новичков.
</p>



<div class="chapter" id="30-&#x441;&#x435;&#x43A;&#x443;&#x43D;&#x434;&#x43D;&#x43E;&#x435; &#x432;&#x432;&#x435;&#x434;&#x435;&#x43D;&#x438;&#x435; &#x432; Web-&#x43F;&#x440;&#x43E;&#x433;&#x440;&#x430;&#x43C;&#x43C;&#x438;&#x440;&#x43E;&#x432;&#x430;&#x43D;&#x438;&#x435; &#x43D;&#x430; &#x441;&#x442;&#x43E;&#x440;&#x43E;&#x43D;&#x435; &#x441;&#x435;&#x440;&#x432;&#x435;&#x440;&#x430;"><h3>30-секундное введение в Web-программирование на стороне сервера</h3>

<p>Хотя в настоящее время Web-программирование обычно означает использование одного из доступных программных каркасов (frameworks) и различных протоколов, основы Web-программирования не особо изменились с момента их появления в начале 1990-х. Для простых приложений, таких как мы напишем в главе 29, вам необходимо понять только несколько основных концепций, так что в этом разделе я сделаю их быстрый обзор. Опытные Web-программисты могут лишь просмотреть, а то и вовсе пропустить этот раздел.<a class="fn_top" id="fnt__1" href="practical-web-programming-with-allegroserve#fn__1">1)</a>
</p>
<p>Для начала вам необходимо понимание ролей Web-браузера и Web-сервера в Web-программировании. Хотя современные браузеры поставляются с кучей свистелок и дуделок (FIXME bells and whistles), основной функциональностью Web-браузера является запрос Web-страниц с Web-сервера и их отображение. Обычно эти страницы пишутся на Hypertext Markup Language (HTML, язык разметки гипертекста), который указывает браузеру как отображать страницу, включая информацию о том, где вставить изображения и ссылки на другие страницы. HTML состоит из текста, <em>размеченного</em> с помощью <em>тегов</em>, которые структурируют текст, а эту структуру браузер использует при отображении страницы. Например, простой
HTML-документ выглядит вот так:
</p>
<pre class="code"><p>&lt;html&gt;<br/>
  &lt;head&gt;<br/>
  &lt;title&gt;Hello&lt;/title&gt;<br/>
  &lt;/head&gt;<br/>
  &lt;body&gt;<br/>
  &lt;p&gt;Hello, world!&lt;/p&gt;<br/>
  &lt;p&gt;This is a picture: &lt;img src="some-image.gif"&gt;&lt;/p&gt;<br/>
  &lt;p&gt;This is a &lt;a href="another-page.html"&gt;link&lt;/a&gt; to another page.&lt;/p&gt;<br/>
  &lt;/body&gt;<br/>
&lt;/html&gt;<br/></p></pre>

<p>Рисунок 26-1 показывает как браузер отображает эту страницу.
</p>
<p>Рисунок 26-1. Пример Web-страницы
</p>
<p>Браузер и сервер общаются между собой используя протокол, называемый Hypertext Transfer Protocol (HTTP, протокол передачи гипертекста). Хотя вам не нужно беспокоиться относительно деталей протокола, полезным будет понимание того, что он полностью состоит из последовательности запросов, инициированных браузером, и ответов, сгенерированных сервером. Таким образом, браузер подключается к Web-серверу и посылает запрос, который включает в себя, как минимум, адрес
желаемого ресурса (URL) и версию протокола HTTP, используемую браузером. Браузер также может включать в запрос дополнительные данные; таким образом браузер отправляет HTML-формы на сервер.
</p>
<p>Для ответа на запрос сервер отправляет ответ, состоящий из наборов заголовков и тела ответа. Заголовки содержат информацию о теле, такую как тип его данных (например, HTML, обычный текст или изображение), а тело ответа содержит сами данные, которые затем отображаются браузером. Сервер также может отправлять ответ-ошибку, который сообщит браузеру о том, что его запрос не может быть обработан по некоторой причине.
</p>
<p>И это почти все. После того, как браузер получил завершенный ответ от сервера, между сервером и браузером не происходит никакого общения до тех пор, пока браузер не решит запросить страницу у сервера в следующий раз<a class="fn_top" id="fnt__2" href="practical-web-programming-with-allegroserve#fn__2">2)</a>. Это основное ограничение Web-программирования – для кода, выполняемого на сервере, не существует способа воздействовать на то, что пользователь увидит в браузере, до тех пор, пока браузер не сделает новый запрос к серверу<a class="fn_top" id="fnt__3" href="practical-web-programming-with-allegroserve#fn__3">3)</a>.
</p>
<p>Некоторые Web-страницы, называемые <em>статическими</em> (<em>static</em>) страницами, являются просто файлами с разметкой на языке HTML, хранимые на Web-сервере и считываемые, когда приходит соответствующий запрос. <em>Динамические</em> (<em>dynamic</em>) страницы, с другой стороны, состоят из HTML, генерируемого при каждом запросе страницы браузером. Например, динамическая страница может быть сгенерирована путем осуществления запроса к базе данных, а затем конструирования HTML для представления результатов этого запроса<a class="fn_top" id="fnt__4" href="practical-web-programming-with-allegroserve#fn__4">4)</a>.
</p>
<p>При генерировании ответа на запрос код, выполняемый на сервере, получает четыре основных части информации, на основании которой он работает. Первой является запрошенный адрес (URL). Но обычно URL используется самим Web-сервером для определения того, какой код ответственен за генерирование ответа. Затем, если URL содержит знак вопроса, то все, что следует за ним, рассматривается как <em>строка запроса</em> (<em>query string</em>), которая обычно игнорируется самим Web-сервером и передается им коду, который будет генерировать ответ. В большинстве случаев строка запроса содержит набор пар имя-значение. Запрос от браузера может также содержать <em>POST-данные</em>, которые также обычно состоят из пар имя-значение. POST-данные обычно используются для передачи содержимого форм HTML. Пары имя-значение, переданные либо через строку запроса, либо через дополнительные данные, обычно называют <em>параметрами запроса</em> (<em>query parameters</em>).
</p>
<p>В заключение, для того, чтобы связать между собой последовательность отдельных запросов от одного и того же браузера, код, выполняющийся на сервере, может установить <em>cookie</em> путем отправки специального заголовка в своем ответе браузеру; этот заголовок будет содержать некий набор данных. После установки cookie браузер будет слать его при каждом запросе, отправляемом этому сервер. Браузер не заботится о данных, хранимых в cookie, — он просто отправляет их обратно на сервер, и код, работающий там, может обрабатывать их так, как захочет.
</p>
<p>Это все базовые элементы, на основании которых основано 99 процентов кода, выполняемого на Web-сервере. Браузер отправляет запрос, сервер находит код, который будет обрабатывать запрос, и запускает его, а код использует параметры запроса и cookies для определения того, что именно нужно сделать.
</p>



</div><div class="chapter" id="AllegroServe"><h3>AllegroServe</h3>

<p>Вы можете отдавать Web-страницы с помощью Common Lisp разными способами; существует по крайней мере три реализации Web-серверов с открытым исходным кодом, написанных на Common Lisp, а также подключаемые модули, такие как mod_lisp<a class="fn_top" id="fnt__5" href="practical-web-programming-with-allegroserve#fn__5">5)</a> и
Lisplets<a class="fn_top" id="fnt__6" href="practical-web-programming-with-allegroserve#fn__6">6)</a>, которые позволяют Web-серверу Apache или любому контейнеру Java Servlet делигировать обработку запросов серверу Lisp, работающему в отдельном процессе.
</p>
<p>В этой главе мы будем использовать Web-сервер с открытым исходным кодом AllegroServe, изначально написанный John Foderaro из Franz Inc. AllegroServe включен в версию Allegro, доступную с сайта Franz для использования с этой книгой. Если вы не используете Allegro, то вы можете использовать PortableAllegroServe, ответвление (fork) кода AllegroServe, которое включает в себя уровень (layer) совместимости с Allegro, что позволяет PortableAllegroServe работать почти на всех реализациях Common Lisp. Код, который мы напишем в этой главе и в главе 29, должен работать как на стандартном AllegroServe, так и на PortableAllegroServe.
</p>
<p>AllegroServe реализует модель программирования сходную по духу с Java Servlets – каждый раз, когда браузер запрашивает страницу, AllegroServe разбирает запрос и ищет объект, называемый <em>сущностью</em> (<em>entity</em>), который будет обрабатывать запрос. Некоторые классы сущностей, предоставляемые как часть AllegroServe,
умеют обрабатывать статическое содержимое: либо отдельные файлы, либо содержимое
каталога. Другие, которые я буду обсуждать большую часть главы, запускают произвольный код на Lisp для генерирования ответа<a class="fn_top" id="fnt__7" href="practical-web-programming-with-allegroserve#fn__7">7)</a>.
</p>
<p>Но перед тем как начать, вам необходимо знать, как запускать AllegroServe и как настроить его для обработки файлов. Первым шагом является загрузка кода AllegroServe в ваш образ Lisp. В Allegro вы можете просто набрать <code>(require :aserve)</code>. В других реализациях Lisp (а также в Allegro), вы можете загрузить PortableAllegroServe путем загрузки файла <code>INSTALL.lisp</code>, находящегося в корне каталога <code>portableaserve</code>. Загрузка AllegroServe создаст три новых пакета: <code>NET.ASERVE</code>, <code>NET.HTML.GENERATOR</code> и <code>NET.ASERVE.CLIENT</code><a class="fn_top" id="fnt__8" href="practical-web-programming-with-allegroserve#fn__8">8)</a>.
</p>
<p>После загрузки сервера, вы можете запустить его с помощью функции <code>start</code> из пакета <code>NET.ASERVE</code>. Чтобы иметь простой доступ к символам, экспортированным из пакета <code>NET.ASERVE</code>, из пакета <code>COM.GIGAMONKEYS.HTML</code> (который мы скоро обсудим), а также остальных частей Common Lisp, нам нужно создать новый пакет:
</p>
<pre class="code"><p>CL-USER&gt; <span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defpkg.htm" class="symbol"><i><span class="symbol">defpackage</span></i></a> <span class="keyword">:com.gigamonkeys.web</span><br/>            <span class="paren2">(<span class=""><span class="keyword">:use</span> <span class="keyword">:cl</span> <span class="keyword">:net.aserve</span> <span class="keyword">:com.gigamonkeys.html</span></span>)</span></span>)</span><br/>
#&lt;The COM.GIGAMONKEYS.WEB package&gt;<br/></p></pre>

<p>Теперь переключитесь на этот пакет с помощью следующего выражения <code>IN-PACKAGE</code>:
</p>
<pre class="code"><p>CL-USER&gt; <span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_in_pkg.htm" class="symbol">in-package</a> <span class="keyword">:com.gigamonkeys.web</span></span>)</span><br/>
#&lt;The COM.GIGAMONKEYS.WEB package&gt;<br/>
WEB&gt;<br/></p></pre><p> 
</p>
<p>Теперь мы можем использовать имена, экспортированные из <code>NET.ASERVE</code>, без указания квалификатора. Функция <code>start</code> запускает сервер. Она принимает множество именованных параметров, но единственный нужный нам — <code>:port</code>, который указывает номер порта, на котором сервер будет принимать запросы.  Возможно вам понадобится использовать большой номера порта, такой как 2001, вместо порта по умолчанию для HTTP-серверов, 80, поскольку в Unix-подобных операционных системах только администратор (root) может использовать порты с номером меньше 1024. Для запуска AllegroServe на порту 80 под Unix вам необходимо запустить Lisp с правами администратора (root), а затем использовать параметры <code>:setuid</code> и <code>:setgid</code> чтобы заставить <code>start</code> переключить пользовательский контекст после открытия этого порта. Вы можете запустить сервер на порту 2001 с помощью следующей команды:
</p>
<pre class="code"><p>WEB&gt; <span class="paren1">(<span class="">start <span class="keyword">:port</span> 2001</span>)</span><br/>
#&lt;WSERVER port 2001 @ #x72511c72&gt;<br/></p></pre>

<p>Теперь сервер выполняется в вашей среде Lisp. Возможно, что при попытке запуска сервера вы получите ошибку вида "port already in use". Это означает, что данный порт уже используется каким-то сервером на вашей машине. В таком случае самым простым решением будет использование другого порта, передав другой аргумент функции <code>start</code>, а затем использование нового значение во всех адресах, встречаемых на протяжении данной главы.
</p>
<p>Вы можете продолжить взаимодействие с Lisp с помощью REPL, поскольку AllegroServe запускает отдельные нити для обработки запросов браузеров. Это означает, среди прочего, что вы можете использовать REPL для того, чтобы заглянуть во "внутренности" сервера во время его работы, что делает тестирование и отладку намного более легкой, по сравнению с тем, когда сервер представляет собой "черный ящик".
</p>
<p>Предполагая, что вы запустили Lisp на той же машине, где находится и ваш браузер, вы можете проверить, что сервер запущен путем перехода в браузере по следующему адресу: <a href="http://localhost:2001/.">http://localhost:2001/.</a> В данный момент вы получите в браузере сообщение об ошибке <code>page-not-found</code> (страница не найдена), поскольку вы пока ничего не опубликовали. Но сообщение об ошибке придет от AllegroServe; это видно по строке внизу страницы. С другой стороны, если браузер отображает ошибку, сообщающую что-то вроде "The connection was refused when attempting to contact localhost:2001", то это означает, что сервер не запущен, или вы запустили его на порту с номером, отличным от 2001.
</p>
<p>Теперь мы можем публиковать файлы. Предположим, что у нас есть файл <code>hello.html</code> в каталоге <code>/tmp/html</code> со следующим содержимым:
</p>
<pre class="code"><p>&lt;html&gt;<br/>
  &lt;head&gt;<br/>
  &lt;title&gt;Hello&lt;/title&gt;<br/>
  &lt;/head&gt;<br/>
  &lt;body&gt;<br/>
  &lt;p&gt;Hello, world!&lt;/p&gt;<br/>
  &lt;/body&gt;<br/>
&lt;/html&gt;<br/></p></pre>

<p>Вы можете опубликовать его с помощью функции <code>publish-file</code>.
</p>
<pre class="code"><p>WEB&gt; <span class="paren1">(<span class="">publish-file <span class="keyword">:path</span> <span class="string">"/hello.html"</span> <span class="keyword">:file</span> <span class="string">"/tmp/html/hello.html"</span></span>)</span><br/>
#&lt;NET.ASERVE::FILE-ENTITY @ #x725eddea&gt;<br/></p></pre>

<p>Аргумент <code>:path</code> задает путь, который будет использоваться в URL, запрашиваемом браузером, а аргумент <code>:file</code> является именем файла на файловой системе. После вычисления выражения <code>publish-file</code> вы можете задать в браузере адрес <a href="http://localhost:2001/hello.html,">http://localhost:2001/hello.html,</a> и он должен отобразить что-то наподобие того, что изображено на рисунке 26-2.
</p>
<p>Рисунок 26-2. <a href="http://localhost:2001/hello.html">http://localhost:2001/hello.html</a>
</p>
<p>Вы также можете опубликовать целый каталог с помощью функции <code>publish-directory</code>. Но сначала давайте избавимся от уже опубликованной сущности с помощью следующего вызова <code>publish-file</code>:
</p>
<pre class="code"><p>WEB&gt; <span class="paren1">(<span class="">publish-file <span class="keyword">:path</span> <span class="string">"/hello.html"</span> <span class="keyword">:remove</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_t.htm" class="symbol">t</a></span>)</span><br/>
NIL<br/></p></pre>

<p>Теперь вы можете опубликовать каталог <code>/tmp/html/</code> целиком (включая его подкаталоги) с помощью функции <code>publish-directory</code>.
</p>
<pre class="code"><p>WEB&gt; <span class="paren1">(<span class="">publish-directory <span class="keyword">:prefix</span> <span class="string">"/"</span> <span class="keyword">:destination</span> <span class="string">"/tmp/html/"</span></span>)</span><br/>
#&lt;NET.ASERVE::DIRECTORY-ENTITY @ #x72625aa2&gt;<br/></p></pre>

<p>В данном случае, аргумент <code>:prefix</code> указывает начало пути адресов URL, которые будут обрабатываться данной сущностью. Так что, если сервер получает запрос <a href="http://localhost:2001/foo/bar.html,">http://localhost:2001/foo/bar.html,</a> то путь будет <code>/foo/bar.html</code>, который начинается с <code>/</code>. Затем этот путь транслируется в имя файла путем замены префикса (<code>/</code>) на аргумент <code>:destination</code> (<code>/tmp/html/</code>). Так что URL <a href="http://localhost:2001/hello.html">http://localhost:2001/hello.html</a> будет преобразован в запрос файла <code>/tmp/html/hello.html</code>.
</p>



</div><div class="chapter" id="&#x413;&#x435;&#x43D;&#x435;&#x440;&#x438;&#x440;&#x43E;&#x432;&#x430;&#x43D;&#x438;&#x435; &#x434;&#x438;&#x43D;&#x430;&#x43C;&#x438;&#x447;&#x435;&#x441;&#x43A;&#x43E;&#x433;&#x43E; &#x441;&#x43E;&#x434;&#x435;&#x440;&#x436;&#x438;&#x43C;&#x43E;&#x433;&#x43E; &#x441; &#x43F;&#x43E;&#x43C;&#x43E;&#x449;&#x44C;&#x44E; AllegroServe"><h3>Генерирование динамического содержимого с помощью AllegroServe</h3>

<p>Публикация сущностей, генерирующих динамическое содержимое, практически также проста, как и публикация статического содержимого. Функции <code>publish</code> и <code>publish-prefix</code> являются "динамическими" аналогами <code>publish-file</code> и <code>publish-directory</code>. Основная их идея заключается в том, что вы публикуете функцию, которая будет вызываться для генерирования ответа на запрос либо к определенному адресу (URL), либо к любому адресу с заданным префиксом. Эта функция будет вызвана с двумя аргументами: объектом, представляющим запрос, и опубликованной сущностью. Большую часть времени нам не нужно будет ничего делать с опубликованной сущностью за исключением ее передачи набору макросов, которые вскоре будут описаны. С другой стороны, мы будем использовать объект запроса для получения информации, переданной браузером: параметров запроса, переданных в строке URL, или данных, посланных формами HTML.
</p>
<p>В качестве простого примера использования функции для генерирования динамического содержимого, давайте напишем функцию, которая будет генерировать страницу с различными случайными числами при каждом обращении к ней.
</p>
<pre class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defun.htm" class="symbol"><i><span class="symbol">defun</span></i></a> random-number <span class="paren2">(<span class="">request entity</span>)</span><br/>  <span class="paren2">(<span class=""><i><span class="symbol">with-http-response</span></i> <span class="paren3">(<span class="">request entity <span class="keyword">:content-type</span> <span class="string">"text/html"</span></span>)</span><br/>    <span class="paren3">(<span class=""><i><span class="symbol">with-http-body</span></i> <span class="paren4">(<span class="">request entity</span>)</span><br/>      <span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_format.htm" class="symbol">format</a> <br/>       <span class="paren5">(<span class="">request-reply-stream request</span>)</span><br/>       <span class="string">"&lt;html&gt;~@<br/>        &lt;head&gt;&lt;title&gt;Random&lt;/title&gt;&lt;/head&gt;~@<br/>        &lt;body&gt;~@<br/>        &lt;p&gt;Random number: ~d&lt;/p&gt;~@<br/>        &lt;/body&gt;~@<br/>        &lt;/html&gt;~@<br/>       "</span><br/>       <span class="paren5">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_random.htm" class="symbol">random</a> 1000</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span><br/></pre>

<p>Макросы <code>with-http-response</code> и <code>with-http-body</code> являются частью AllegroServe. Первый из макросов начинает процесс генерирования ответа HTTP и может быть использован, также как в нашем примере, для указания таких вещей, как тип возвращаемых данных. Он также обрабатывает различные требования, указанные в стандарте HTTP, такие как обработка запросов <code>If-Modified-Since</code>. Макрос же <code>with-http-body</code> фактически отправляет заголовки HTTP ответа, а затем вычисляет свое тело, которое должно содержать код, генерирующий содержимое ответа. Внутри <code>with-http-response</code>, но перед <code>with-http-body</code>, вы можете добавить или изменить значение заголовков HTTP, которые будут отправлены в ответе. Функция <code>request-reply-stream</code> также является частью AllegroServe и возвращает поток, в который вы должны записывать данные предназначенные для отправления браузеру.
</p>
<p>Как видно из этой функции, вы можете просто использовать <strong>FORMAT</strong> для вывода HTML в поток, возвращенный вызовом <code>request-reply-stream</code>. В следующем разделе я покажу вам более удобные способы программного генерирования HTML<a class="fn_top" id="fnt__9" href="practical-web-programming-with-allegroserve#fn__9">9)</a>.
</p>
<p>Теперь мы готовы к публикации данной функции.
</p>
<pre class="code"><p>WEB&gt; <span class="paren1">(<span class="">publish <span class="keyword">:path</span> <span class="string">"/random-number"</span> <span class="keyword">:function</span> 'random-number</span>)</span><br/>
#&lt;COMPUTED-ENTITY @ #x7262bab2&gt;<br/></p></pre>

<p>Также, как и в функции <code>publish-file</code>, аргумент <code>:path</code> указывает "путевую часть" (path part) адреса, указание которой будет приводить к вызову данной функции.  Аргумент <code>:function</code> указывает либо имя функции, либо сам функциональный объект. Использование имени функции, как показано в этом примере, позволяет вам в дальнейшем переопределить функцию не выполняя заново процесс публикации для того, чтобы AllegroServe стал использовать новое определение. После вычисления данного вызова вы можете указать в браузере адрес <a href="http://localhost:2001/random-number">http://localhost:2001/random-number</a> для получения страницы со случайным числом, как это показано на рисунке 26-3.
</p>
<p>Рисунок 26-3. <a href="http://localhost:2001/random-number">http://localhost:2001/random-number</a>
</p>



</div><div class="chapter" id="&#x413;&#x435;&#x43D;&#x435;&#x440;&#x438;&#x440;&#x43E;&#x432;&#x430;&#x43D;&#x438;&#x435; HTML"><h3>Генерирование HTML</h3>

<p>Хотя использование <strong>FORMAT</strong> для генерирования HTML вполне приемлемо для генерирования простых страниц, наподобие приведенной выше, по мере того, как вы начнете создавать более сложные, было бы лучше иметь более краткий способ генерирования HTML. Для генерирования HTML из представления в виде s-выражений существует несколько библиотек, включая <code>htmlgen</code>, которая поставляется вместе с AllegroServe. В этой главе мы будем использовать библиотеку <code>FOO</code>,<a class="fn_top" id="fnt__10" href="practical-web-programming-with-allegroserve#fn__10">10)</a>, которая использует примерно ту же модель, что и htmlgen, и чью реализацию мы рассмотрим более подробно в главах 30 и 31. Сейчас, однако, нам нужно лишь знать как использовать <code>FOO</code>.
</p>
<p>Генерирование HTML из Lisp вполне естественна, так как s-выражения и HTML по своему существу изоморфны. Мы можем представить HTML-элементы с помощью s-выражений, рассматривая каждый элемент HTML как список, "помеченный" соответствующим первым элементом, таким как ключевым символом с таким же именем, что имеет тег HTML. Таким образом, HTML <code>&lt;p&gt;foo&lt;/p&gt;</code> представляется s-выражением <code>(:p "foo")</code>. Так как элементы HTML также, как и списки в s-выражениях, могут быть вложенными, эта схема распространяется и на более сложный HTML. Для примера вот такой HTML:
</p>
<pre class="code"><p>&lt;html&gt;<br/>
  &lt;head&gt;<br/>
  &lt;title&gt;Hello&lt;/title&gt;<br/>
  &lt;/head&gt;<br/>
  &lt;body&gt;<br/>
  &lt;p&gt;Hello, world!&lt;/p&gt;<br/>
  &lt;/body&gt;<br/>
&lt;/html&gt;<br/></p></pre>

<p>может быть представлен в виде следующего s-выражения:
</p>
<pre class="code"><span class="paren1">(<span class=""><span class="keyword">:html</span><br/>  <span class="paren2">(<span class=""><span class="keyword">:head</span> <span class="paren3">(<span class=""><span class="keyword">:title</span> <span class="string">"Hello"</span></span>)</span></span>)</span><br/>  <span class="paren2">(<span class=""><span class="keyword">:body</span> <span class="paren3">(<span class=""><span class="keyword">:p</span> <span class="string">"Hello, world!"</span></span>)</span></span>)</span></span>)</span><br/></pre>

<p>Элементы HTML с атрибутами несколько усложняют дело, но не создают непреодолимых проблем. <code>FOO</code> предоставляет два способа включения атрибут в тег. Одним из них является добавление после первого элемента списка пар ключ-значение. Первый же элемент, который следует за парами ключ-значение, и который сам не является ключевым символом, обозначает начало содержимого элемента. Таким образом, такой HTML:
</p>
<pre class="code"><p>&lt;a href="foo.html"&gt;This is a link&lt;/a&gt;<br/></p></pre>

<p>будет представляться следующим s-выражением:
</p>
<pre class="code"><span class="paren1">(<span class=""><span class="keyword">:a</span> <span class="keyword">:href</span> <span class="string">"foo.html"</span> <span class="string">"This is a link"</span></span>)</span><br/></pre>

<p>Другой предоставляемый <code>FOO</code> синтаксис заключается в группировке имени тега и его атрибутов в отдельный список следующим образом:
</p>
<pre class="code"><span class="paren1">(<span class=""><span class="paren2">(<span class=""><span class="keyword">:a</span> <span class="keyword">:href</span> <span class="string">"foo.html"</span></span>)</span> <span class="string">"This is link."</span></span>)</span><br/></pre>

<p><code>FOO</code> может использовать представление HTML в виде s-выражений двумя способами. Функция <code>emit-html</code> получает представляющее HTML s-выражение и выводит соответствующий HTML.
</p>
<pre class="code"><p>WEB&gt; <span class="paren1">(<span class="">emit-html '<span class="paren2">(<span class=""><span class="keyword">:html</span> <span class="paren3">(<span class=""><span class="keyword">:head</span> <span class="paren4">(<span class=""><span class="keyword">:title</span> <span class="string">"Hello"</span></span>)</span></span>)</span> <span class="paren3">(<span class=""><span class="keyword">:body</span> <span class="paren4">(<span class=""><span class="keyword">:p</span> <span class="string">"Hello, world!"</span></span>)</span></span>)</span></span>)</span></span>)</span><br/>
&lt;html&gt;<br/>
  &lt;head&gt;<br/>
    &lt;title&gt;Hello&lt;/title&gt;<br/>
  &lt;/head&gt;<br/>
  &lt;body&gt;<br/>
    &lt;p&gt;Hello, world!&lt;/p&gt;<br/>
  &lt;/body&gt;<br/>
&lt;/html&gt;<br/>
T<br/></p></pre>

<p>Однако, <code>emit-html</code> не всегда является наиболее эффективным способом генерирования HTML, так как ее аргументом должно быть законченное s-выражениее, предоставляющее HTML, который нужно сгенерировать. Хотя генерировать такое представление легко, действовать так не всегда эффективно. Например, представим, что нам нужно сгенерировать страницу HTML, содержащую список из 10,000 случайных чисел. Мы можем построить соответствующее s-выражение используя шаблон квазицитирования, а затем передать его в функцию <code>emit-html</code>:
</p>
<pre class="code"><span class="paren1">(<span class="">emit-html<br/>  `<span class="paren2">(<span class=""><span class="keyword">:html</span><br/>     <span class="paren3">(<span class=""><span class="keyword">:head</span><br/>       <span class="paren4">(<span class=""><span class="keyword">:title</span> <span class="string">"Random numbers"</span></span>)</span></span>)</span><br/>     <span class="paren3">(<span class=""><span class="keyword">:body</span> <br/>       <span class="paren4">(<span class=""><span class="keyword">:h1</span> <span class="string">"Random numbers"</span></span>)</span><br/>       <span class="paren4">(<span class=""><span class="keyword">:p</span> ,@<span class="paren5">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_loop.htm" class="symbol"><i><span class="symbol">loop</span></i></a> repeat 10000 collect <span class="paren6">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_random.htm" class="symbol">random</a> 1000</span>)</span> collect <span class="string">" "</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span><br/></pre>

<p>Однако этот код должен построить дерево, содержащее 10000-элементный список, перед тем как он сможет даже начать генерировать HTML, и все это s-выражение станет мусором как только HTML будет сгенерирован. Для избежания такой неэффективности <code>FOO</code> также предоставляет макрос <code>html</code>, позволяющий вам встраивать произвольный код Lisp в середину s-выражения, по которому будет генерироваться HTML.
</p>
<p>Литеральные значения, такие как строки и числа, входа <code>html</code> будут подставлены в генерируемый HTML. Также, символы интерпретируются как ссылки на переменные, которые они именуют, и сгенерированный код будет брать их значения во время выполнения. Таким образом оба следующих выражения:
</p>
<pre class="code"><span class="paren1">(<span class="">html <span class="paren2">(<span class=""><span class="keyword">:p</span> <span class="string">"foo"</span></span>)</span></span>)</span><br/><br/><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_let_l.htm" class="symbol"><i><span class="symbol">let</span></i></a> <span class="paren2">(<span class=""><span class="paren3">(<span class="">x <span class="string">"foo"</span></span>)</span></span>)</span> <span class="paren2">(<span class="">html <span class="paren3">(<span class=""><span class="keyword">:p</span> x</span>)</span></span>)</span></span>)</span><br/></pre>

<p>сгенерируют следующее:
</p>
<pre class="code"><p>&lt;p&gt;foo&lt;/p&gt;<br/></p></pre>

<p>Формы списков, которые не начинаются с ключевых символов, рассматриваются как код и встраиваются в генерируемый код. Любые значения, возращаемые встроенным кодом, будут проигнорированы, но такой код сам может генерировать HTML путем вызова <code>html</code>. Например, для генерирования содержимого списка в виде HTML, мы можем написать следующее:
</p>
<pre class="code"><span class="paren1">(<span class="">html <span class="paren2">(<span class=""><span class="keyword">:ul</span> <span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_dolist.htm" class="symbol">dolist</a> <span class="paren4">(<span class="">item <span class="paren5">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_list.htm" class="symbol">list</a> 1 2 3</span>)</span></span>)</span> <span class="paren4">(<span class="">html <span class="paren5">(<span class=""><span class="keyword">:li</span> item</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span><br/></pre>

<p>что сгенерирует следующий HTML:
</p>
<pre class="code"><p>&lt;ul&gt;<br/>
  &lt;li&gt;1&lt;/li&gt;<br/>
  &lt;li&gt;2&lt;/li&gt;<br/>
  &lt;li&gt;3&lt;/li&gt;<br/>
&lt;/ul&gt;<br/></p></pre>

<p>Если вы захотите выдать значение формы, вы должны обернуть его в псевдотег <code>:print</code>. Таким образом, выражение:
</p>
<pre class="code"><span class="paren1">(<span class="">html <span class="paren2">(<span class=""><span class="keyword">:p</span> <span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_pl.htm" class="symbol">+</a> 1 2</span>)</span></span>)</span></span>)</span><br/></pre>

<p>сгенерирует такой HTML после вычисления и отбрасывания значения <code>3</code>:
</p>
<pre class="code"><p>&lt;p&gt;&lt;/p&gt;<br/></p></pre>

<p>Для выдачи <code>3</code> вы должны написать такой код:
</p>
<pre class="code"><span class="paren1">(<span class="">html <span class="paren2">(<span class=""><span class="keyword">:p</span> <span class="paren3">(<span class=""><span class="keyword">:print</span> <span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_pl.htm" class="symbol">+</a> 1 2</span>)</span></span>)</span></span>)</span></span>)</span><br/></pre>

<p>Или же вы можете вычислить значение и сохранить его в переменной вне вызова <code>html</code> следующим образом:
</p>
<pre class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_let_l.htm" class="symbol"><i><span class="symbol">let</span></i></a> <span class="paren2">(<span class=""><span class="paren3">(<span class="">x <span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_pl.htm" class="symbol">+</a> 1 2</span>)</span></span>)</span></span>)</span> <span class="paren2">(<span class="">html <span class="paren3">(<span class=""><span class="keyword">:p</span> x</span>)</span></span>)</span></span>)</span><br/></pre>

<p>Таким образом вы можете использовать макрос <code>html</code> для генерирования списка случайных чисел следующим образом:
</p>
<pre class="code"><span class="paren1">(<span class="">html<br/>  <span class="paren2">(<span class=""><span class="keyword">:html</span><br/>    <span class="paren3">(<span class=""><span class="keyword">:head</span><br/>      <span class="paren4">(<span class=""><span class="keyword">:title</span> <span class="string">"Random numbers"</span></span>)</span></span>)</span><br/>    <span class="paren3">(<span class=""><span class="keyword">:body</span> <br/>      <span class="paren4">(<span class=""><span class="keyword">:h1</span> <span class="string">"Random numbers"</span></span>)</span><br/>      <span class="paren4">(<span class=""><span class="keyword">:p</span> <span class="paren5">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_loop.htm" class="symbol"><i><span class="symbol">loop</span></i></a> repeat 10 <a href="http://www.lispworks.com/reference/HyperSpec/Body/m_do_do.htm" class="symbol">do</a> <span class="paren6">(<span class="">html <span class="paren1">(<span class=""><span class="keyword">:print</span> <span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_random.htm" class="symbol">random</a> 1000</span>)</span></span>)</span> <span class="string">" "</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span><br/></pre>

<p>Версия, использующая макрос <code>html</code>, будет эффективнее, чем использующая <code>emit-html</code>. И не только из-за того, что теперь не нужно генерировать s-выражение, представляющее страницу целиком, но и из-за того, что большая часть работы по интерпретации s-выражения, которую <code>emit-html</code> осуществляет во время выполнения, будет сделана однократно, во время раскрытия макроса, а не каждый раз при выполнении кода.
</p>
<p>Вы можете управлять тем, куда будет отправлен вывод <code>html</code> и <code>emit-html</code>, с помощью макроса <code>with-html-output</code>, который также является частью библиотеки <code>FOO</code>. Вы можете использовать макросы <code>with-html-output</code> и <code>html</code> для переписывания <code>random-number</code> следущим образом:
</p>
<pre class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defun.htm" class="symbol"><i><span class="symbol">defun</span></i></a> random-number <span class="paren2">(<span class="">request entity</span>)</span><br/>  <span class="paren2">(<span class=""><i><span class="symbol">with-http-response</span></i> <span class="paren3">(<span class="">request entity <span class="keyword">:content-type</span> <span class="string">"text/html"</span></span>)</span><br/>    <span class="paren3">(<span class=""><i><span class="symbol">with-http-body</span></i> <span class="paren4">(<span class="">request entity</span>)</span><br/>      <span class="paren4">(<span class=""><i><span class="symbol">with-html-output</span></i> <span class="paren5">(<span class=""><span class="paren6">(<span class="">request-reply-stream request</span>)</span></span>)</span><br/>        <span class="paren5">(<span class="">html<br/>          <span class="paren6">(<span class=""><span class="keyword">:html</span><br/>            <span class="paren1">(<span class=""><span class="keyword">:head</span> <span class="paren2">(<span class=""><span class="keyword">:title</span> <span class="string">"Random"</span></span>)</span></span>)</span><br/>            <span class="paren1">(<span class=""><span class="keyword">:body</span><br/>              <span class="paren2">(<span class=""><span class="keyword">:p</span> <span class="string">"Random number: "</span> <span class="paren3">(<span class=""><span class="keyword">:print</span> <span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_random.htm" class="symbol">random</a> 1000</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span><br/></pre>




</div><div class="chapter" id="&#x41C;&#x430;&#x43A;&#x440;&#x43E;&#x441;&#x44B; HTML"><h3>Макросы HTML</h3>

<p>Другой возможностью <code>FOO</code> является то, что он позволяет вам определять "макросы" HTML, которые могут преобразовывать произвольные формы в представляющие HTML s-выражения, которые понимает макрос <code>html</code>. Например, предположим, что вы заметили, что часто создаете страницы следующего вида:
</p>
<pre class="code"><span class="paren1">(<span class=""><span class="keyword">:html</span><br/>  <span class="paren2">(<span class=""><span class="keyword">:head</span> <span class="paren3">(<span class=""><span class="keyword">:title</span> <span class="string">"Some title"</span></span>)</span></span>)</span><br/>  <span class="paren2">(<span class=""><span class="keyword">:body</span><br/>    <span class="paren3">(<span class=""><span class="keyword">:h1</span> <span class="string">"Some title"</span></span>)</span><br/>    ... stuff ...</span>)</span></span>)</span><br/></pre>

<p>Вы можете определить макрос HTML, представляющий этот образец, следующим образом:
</p>
<pre class="code"><span class="paren1">(<span class=""><i><span class="symbol">define-html-macro</span></i> <span class="keyword">:standard-page</span> <span class="paren2">(<span class=""><span class="paren3">(<span class="">&amp;key title</span>)</span> &amp;body body</span>)</span><br/>  `<span class="paren2">(<span class=""><span class="keyword">:html</span><br/>     <span class="paren3">(<span class=""><span class="keyword">:head</span> <span class="paren4">(<span class=""><span class="keyword">:title</span> ,title</span>)</span></span>)</span><br/>     <span class="paren3">(<span class=""><span class="keyword">:body</span><br/>      <span class="paren4">(<span class=""><span class="keyword">:h1</span> ,title</span>)</span><br/>      ,@body</span>)</span></span>)</span></span>)</span><br/></pre>

<p>Теперь вы можете использовать "тег" <code>:standard-page</code> в ваших представляющих HTML s-выражениях, и он будет раскрыт перед интерпретацией или компиляцией этих выражений. Например, следующий код:
</p>
<pre class="code"><span class="paren1">(<span class="">html <span class="paren2">(<span class=""><span class="keyword">:standard-page</span> <span class="paren3">(<span class=""><span class="keyword">:title</span> <span class="string">"Hello"</span></span>)</span> <span class="paren3">(<span class=""><span class="keyword">:p</span> <span class="string">"Hello, world."</span></span>)</span></span>)</span></span>)</span><br/></pre>

<p>сгенерирует такой HTML:
</p>
<pre class="code"><p>&lt;html&gt;<br/>
  &lt;head&gt;<br/>
    &lt;title&gt;Hello&lt;/title&gt;<br/>
  &lt;/head&gt;<br/>
  &lt;body&gt;<br/>
    &lt;h1&gt;Hello&lt;/h1&gt;<br/>
    &lt;p&gt;Hello, world.&lt;/p&gt;<br/>
  &lt;/body&gt;<br/>
&lt;/html&gt;<br/></p></pre>




</div><div class="chapter" id="&#x41F;&#x430;&#x440;&#x430;&#x43C;&#x435;&#x442;&#x440;&#x44B; &#x437;&#x430;&#x43F;&#x440;&#x43E;&#x441;&#x430;"><h3>Параметры запроса</h3>

<p>Конечно, генерирование HTML является только половиной темы web-программирования. Еще одной вещью, которую вы должны уметь делать, является получение ввода от пользователя. Как я рассказывал в разделе "30-секундное введение в web-программирование на стороне сервера", когда браузер запрашивает страницу у web-сервера, он может послать параметры запроса в адресе URL или POST-данные, и оба этих источника рассматриваются как ввод для кода на стороне сервера.
</p>
<p>AllegroServe, как и большинство других каркасов web-программирования, берет на себя заботу о разборе обоих этих источников ввода для вас. В то время когда ваша опубликованная функция вызывается, все пары ключ-значение из строки запроса и/или POST-данных уже декодированы и помещены в ассоциативный список (alist), который вы можете получить из объекта запроса с помощью функции <code>request-query</code>. Следующая функция возвращает страницу, отображающую все полученные ею параметры запроса:
</p>
<pre class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defun.htm" class="symbol"><i><span class="symbol">defun</span></i></a> show-query-params <span class="paren2">(<span class="">request entity</span>)</span><br/>  <span class="paren2">(<span class=""><i><span class="symbol">with-http-response</span></i> <span class="paren3">(<span class="">request entity <span class="keyword">:content-type</span> <span class="string">"text/html"</span></span>)</span><br/>    <span class="paren3">(<span class=""><i><span class="symbol">with-http-body</span></i> <span class="paren4">(<span class="">request entity</span>)</span><br/>      <span class="paren4">(<span class=""><i><span class="symbol">with-html-output</span></i> <span class="paren5">(<span class=""><span class="paren6">(<span class="">request-reply-stream request</span>)</span></span>)</span><br/>        <span class="paren5">(<span class="">html<br/>          <span class="paren6">(<span class=""><span class="keyword">:standard-page</span><br/>           <span class="paren1">(<span class=""><span class="keyword">:title</span> <span class="string">"Query Parameters"</span></span>)</span><br/>           <span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_if.htm" class="symbol"><i><span class="symbol">if</span></i></a> <span class="paren2">(<span class="">request-query request</span>)</span><br/>             <span class="paren2">(<span class="">html <br/>               <span class="paren3">(<span class=""><span class="keyword">:table</span> <span class="keyword">:border</span> 1<br/>                       <span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_loop.htm" class="symbol"><i><span class="symbol">loop</span></i></a> for <span class="paren5">(<span class="">k . v</span>)</span> in <span class="paren5">(<span class="">request-query request</span>)</span><br/>                          <a href="http://www.lispworks.com/reference/HyperSpec/Body/m_do_do.htm" class="symbol">do</a> <span class="paren5">(<span class="">html <span class="paren6">(<span class=""><span class="keyword">:tr</span> <span class="paren1">(<span class=""><span class="keyword">:td</span> k</span>)</span> <span class="paren1">(<span class=""><span class="keyword">:td</span> v</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span><br/>             <span class="paren2">(<span class="">html <span class="paren3">(<span class=""><span class="keyword">:p</span> <span class="string">"No query parameters."</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span><br/><br/><span class="paren1">(<span class="">publish <span class="keyword">:path</span> <span class="string">"/show-query-params"</span> <span class="keyword">:function</span> 'show-query-params</span>)</span><br/></pre>

<p>Если вы укажете своему браузеру URL со строкой запроса подобной такой:
</p><pre>http://localhost:2001/show-query-params?foo=bar&amp;baz=10<br/></pre>
<p>вы получите страницу, подобную показанной на рисунке 26-4.
</p>
<p>Рисунок 26-4. <a href="http://localhost:2001/show-query-params?foo">http://localhost:2001/show-query-params?foo</a>=bar&amp;baz=10
</p>
<p>Для генерирования POST-данных нам нужна форма HTML. Следующая функция генерирует простую форму, которая посылает свои данные show-query-params:
</p>
<pre class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defun.htm" class="symbol"><i><span class="symbol">defun</span></i></a> simple-form <span class="paren2">(<span class="">request entity</span>)</span><br/>  <span class="paren2">(<span class=""><i><span class="symbol">with-http-response</span></i> <span class="paren3">(<span class="">request entity <span class="keyword">:content-type</span> <span class="string">"text/html"</span></span>)</span><br/>    <span class="paren3">(<span class=""><i><span class="symbol">with-http-body</span></i> <span class="paren4">(<span class="">request entity</span>)</span><br/>      <span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_let_l.htm" class="symbol"><i><span class="symbol">let</span></i></a> <span class="paren5">(<span class=""><span class="paren6">(<span class=""><span class="special">*html-output*</span> <span class="paren1">(<span class="">request-reply-stream request</span>)</span></span>)</span></span>)</span><br/>        <span class="paren5">(<span class="">html<br/>          <span class="paren6">(<span class=""><span class="keyword">:html</span><br/>            <span class="paren1">(<span class=""><span class="keyword">:head</span> <span class="paren2">(<span class=""><span class="keyword">:title</span> <span class="string">"Simple Form"</span></span>)</span></span>)</span><br/>            <span class="paren1">(<span class=""><span class="keyword">:body</span><br/>             <span class="paren2">(<span class=""><span class="keyword">:form</span> <span class="keyword">:method</span> <span class="string">"POST"</span> <span class="keyword">:action</span> <span class="string">"/show-query-params"</span><br/>               <span class="paren3">(<span class=""><span class="keyword">:table</span><br/>                <span class="paren4">(<span class=""><span class="keyword">:tr</span> <span class="paren5">(<span class=""><span class="keyword">:td</span> <span class="string">"Foo"</span></span>)</span><br/>                     <span class="paren5">(<span class=""><span class="keyword">:td</span> <span class="paren6">(<span class=""><span class="keyword">:input</span> <span class="keyword">:name</span> <span class="string">"foo"</span> <span class="keyword">:size</span> 20</span>)</span></span>)</span></span>)</span><br/>                <span class="paren4">(<span class=""><span class="keyword">:tr</span> <span class="paren5">(<span class=""><span class="keyword">:td</span> <span class="string">"Password"</span></span>)</span><br/>                     <span class="paren5">(<span class=""><span class="keyword">:td</span> <span class="paren6">(<span class=""><span class="keyword">:input</span> <span class="keyword">:name</span> <span class="string">"password"</span> <span class="keyword">:type</span> <span class="string">"password"</span> <span class="keyword">:size</span> 20</span>)</span></span>)</span></span>)</span></span>)</span><br/>               <span class="paren3">(<span class=""><span class="keyword">:p</span> <span class="paren4">(<span class=""><span class="keyword">:input</span> <span class="keyword">:name</span> <span class="string">"submit"</span> <span class="keyword">:type</span> <span class="string">"submit"</span> <span class="keyword">:value</span> <span class="string">"Okay"</span></span>)</span><br/>                   <span class="paren4">(<span class=""><span class="keyword">:input</span> <span class="keyword">::type</span> <span class="string">"reset"</span> <span class="keyword">:value</span> <span class="string">"Reset"</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span><br/><br/><span class="paren1">(<span class="">publish <span class="keyword">:path</span> <span class="string">"/simple-form"</span> <span class="keyword">:function</span> 'simple-form</span>)</span><br/></pre>

<p>Перейдите в вашем браузере по адресу  <a href="http://localhost:2001/simple-form">http://localhost:2001/simple-form</a>; вы должны увидеть страницу, подобную изображенной на рисунке 26-5.
</p>
<p>Если вы заполните форму значениями "abc" и "def", щелкните на кнопку <code>Okay</code>, то получите страницу, сходную с изображенной на рисунке 26-6.
</p>
<p>Рисунок 26-5. <a href="http://localhost:2001/simple-form">http://localhost:2001/simple-form</a>
</p>
<p>Рисунок 26-6. Результат посылки простой формы
</p>
<p>Однако, чаще всего вам не нужно проходить по всем параметрам запроса: обычно вам нужно просто получить определенный параметр. Например, вы можете захотеть модифицировать <code>random-number</code> так, чтобы предельное значение, передаваемое в функцию <strong>RANDOM</strong>, предоставлялось как параметр запроса. В таком случае используется функция <code>request-query-value</code>, получающая объект запроса и имя параметра, значение которого вы хотите получить. Она возвращает либо значение параметра в виде строки, либо <strong>NIL</strong>, если такой параметр не предоставлен. "Параметризованная" версия <code>random-number</code> может выглядеть следующим образом:
</p>
<pre class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defun.htm" class="symbol"><i><span class="symbol">defun</span></i></a> random-number <span class="paren2">(<span class="">request entity</span>)</span><br/>  <span class="paren2">(<span class=""><i><span class="symbol">with-http-response</span></i> <span class="paren3">(<span class="">request entity <span class="keyword">:content-type</span> <span class="string">"text/html"</span></span>)</span><br/>    <span class="paren3">(<span class=""><i><span class="symbol">with-http-body</span></i> <span class="paren4">(<span class="">request entity</span>)</span><br/>      <span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_let_l.htm" class="symbol"><i><span class="symbol">let*</span></i></a> <span class="paren5">(<span class=""><span class="paren6">(<span class=""><span class="special">*html-output*</span> <span class="paren1">(<span class="">request-reply-stream request</span>)</span></span>)</span><br/>             <span class="paren6">(<span class="">limit-string <span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_or.htm" class="symbol">or</a> <span class="paren2">(<span class="">request-query-value <span class="string">"limit"</span> request</span>)</span> <span class="string">""</span></span>)</span></span>)</span><br/>             <span class="paren6">(<span class="">limit <span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_or.htm" class="symbol">or</a> <span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_parse_.htm" class="symbol">parse-integer</a> limit-string <span class="keyword">:junk-allowed</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_t.htm" class="symbol">t</a></span>)</span> 1000</span>)</span></span>)</span></span>)</span><br/>        <span class="paren5">(<span class="">html<br/>          <span class="paren6">(<span class=""><span class="keyword">:html</span><br/>            <span class="paren1">(<span class=""><span class="keyword">:head</span> <span class="paren2">(<span class=""><span class="keyword">:title</span> <span class="string">"Random"</span></span>)</span></span>)</span><br/>            <span class="paren1">(<span class=""><span class="keyword">:body</span><br/>              <span class="paren2">(<span class=""><span class="keyword">:p</span> <span class="string">"Random number: "</span> <span class="paren3">(<span class=""><span class="keyword">:print</span> <span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_random.htm" class="symbol">random</a> limit</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span><br/></pre>

<p>Так как request-query-value может возвращать как <strong>NIL</strong>, так и пустую строку, мы должны обрабатывать оба этих случая при разборе параметра и его преобразования в число, которое будет передано <strong>RANDOM</strong>. Мы можем обработать значение <strong>NIL</strong> при связывании переменной <code>limit-string</code>, связывая ее с "" если параметра "limit" нет. Затем мы можем использовать аргумент функции <strong>PARSE-INTEGER</strong> <code>:junk-allowed</code> для гарантии того, что она вернет либо <strong>NIL</strong> (если не сможет разобрать целое число из переданной строки), либо целое число. В разделе "Небольшой каркас приложений" мы разработаем несколько макросов для облегчения работы по получению параметров запроса и преобразования их в различные типы.
</p>



</div><div class="chapter" id="Cookies"><h3>Cookies</h3>

<p>В AllegroServe вы можете послать заголовок <code>Set-Cookie</code>, который укажет браузеру сохранить cookie и посылать его со всеми последующими запросами, путем вызова функции <code>set-cookie-header</code> внутри тела <code>with-http-response</code>, но перед вызовом <code>with-http-body</code>. Первый аргумент этой функции должен быть объектом запроса, а остальные аргументы — ключевые аргументы, используемые для установки различных свойств cookie. Обязательными являются лишь два аргумента: <code>:name</code> и <code>:value</code>, оба из которых являются строками. Остальные возможные аргументы, влияющие на посылаемый браузеру cookie: <code>:expires</code>, <code>:path</code>, <code>:domain</code> и <code>:secure</code>.
</p>
<p>Из этих аргументов нам следует обратить внимание лишь на <code>:expires</code>. Он управляет тем, как долго браузер должен сохранять cookie. Если <code>:expires</code> равен <strong>NIL</strong> (по умолчанию), браузер сохранит cookie только до завершения своей работы. Другие возможные значения: <code>:never</code>, что означает, что cookie должен сохраняться навсегда, или всемирное (universal) время, как возвращается <strong>GET-UNIVERSAL-TIME</strong> или <strong>ENCODE-UNIVERSAL-TIME</strong>. Значение <code>:expires</code> равное нулю указывает клиенту немедленно удалить существующие cookie<a class="fn_top" id="fnt__11" href="practical-web-programming-with-allegroserve#fn__11">11)</a>.
</p>
<p>После того как вы установили cookie, вы можете использовать функцию <code>get-cookie-values</code> для получения ассоциативного списка (alist), содержащего по паре имя-значение на каждый cookie, посланный браузером. Из этого списка вы можете получить значения отдельных cookie с помощью <strong>ASSOC</strong> и <strong>CDR</strong>.
</p>
<p>Следующая функция отображает имена и значения всех cookie, посланных браузером:
</p>
<pre class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defun.htm" class="symbol"><i><span class="symbol">defun</span></i></a> show-cookies <span class="paren2">(<span class="">request entity</span>)</span><br/>  <span class="paren2">(<span class=""><i><span class="symbol">with-http-response</span></i> <span class="paren3">(<span class="">request entity <span class="keyword">:content-type</span> <span class="string">"text/html"</span></span>)</span><br/>    <span class="paren3">(<span class=""><i><span class="symbol">with-http-body</span></i> <span class="paren4">(<span class="">request entity</span>)</span><br/>      <span class="paren4">(<span class=""><i><span class="symbol">with-html-output</span></i> <span class="paren5">(<span class=""><span class="paren6">(<span class="">request-reply-stream request</span>)</span></span>)</span><br/>        <span class="paren5">(<span class="">html<br/>          <span class="paren6">(<span class=""><span class="keyword">:standard-page</span><br/>           <span class="paren1">(<span class=""><span class="keyword">:title</span> <span class="string">"Cookies"</span></span>)</span><br/>           <span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_if.htm" class="symbol"><i><span class="symbol">if</span></i></a> <span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_null.htm" class="symbol">null</a> <span class="paren3">(<span class="">get-cookie-values request</span>)</span></span>)</span><br/>             <span class="paren2">(<span class="">html <span class="paren3">(<span class=""><span class="keyword">:p</span> <span class="string">"No cookies."</span></span>)</span></span>)</span><br/>             <span class="paren2">(<span class="">html <br/>               <span class="paren3">(<span class=""><span class="keyword">:table</span><br/>                 <span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_loop.htm" class="symbol"><i><span class="symbol">loop</span></i></a> for <span class="paren5">(<span class="">key . value</span>)</span> in <span class="paren5">(<span class="">get-cookie-values request</span>)</span><br/>                    <a href="http://www.lispworks.com/reference/HyperSpec/Body/m_do_do.htm" class="symbol">do</a> <span class="paren5">(<span class="">html <span class="paren6">(<span class=""><span class="keyword">:tr</span> <span class="paren1">(<span class=""><span class="keyword">:td</span> key</span>)</span> <span class="paren1">(<span class=""><span class="keyword">:td</span> value</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span><br/><br/><span class="paren1">(<span class="">publish <span class="keyword">:path</span> <span class="string">"/show-cookies"</span> <span class="keyword">:function</span> 'show-cookies</span>)</span><br/></pre>

<p>При первой загрузке страницы <code><a href="http://localhost:2001/show-cookies">http://localhost:2001/show-cookies</a></code> она должна отобразить сообщение "No cookies" как показано на рисунке 26-7, так как вы еще ничего не установили.
</p>
<p>Рисунок 26-7. <a href="http://localhost:2001/show-cookies">http://localhost:2001/show-cookies</a> без установленных cookie
</p>
<p>Для установки cookie нам понадобится другая функция, такая как эта:
</p>
<pre class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defun.htm" class="symbol"><i><span class="symbol">defun</span></i></a> set-cookie <span class="paren2">(<span class="">request entity</span>)</span><br/>  <span class="paren2">(<span class=""><i><span class="symbol">with-http-response</span></i> <span class="paren3">(<span class="">request entity <span class="keyword">:content-type</span> <span class="string">"text/html"</span></span>)</span><br/>    <span class="paren3">(<span class="">set-cookie-header request <span class="keyword">:name</span> <span class="string">"MyCookie"</span> <span class="keyword">:value</span> <span class="string">"A cookie value"</span></span>)</span><br/>    <span class="paren3">(<span class=""><i><span class="symbol">with-http-body</span></i> <span class="paren4">(<span class="">request entity</span>)</span><br/>      <span class="paren4">(<span class=""><i><span class="symbol">with-html-output</span></i> <span class="paren5">(<span class=""><span class="paren6">(<span class="">request-reply-stream request</span>)</span></span>)</span><br/>        <span class="paren5">(<span class="">html <br/>          <span class="paren6">(<span class=""><span class="keyword">:standard-page</span><br/>           <span class="paren1">(<span class=""><span class="keyword">:title</span> <span class="string">"Set Cookie"</span></span>)</span><br/>           <span class="paren1">(<span class=""><span class="keyword">:p</span> <span class="string">"Cookie set."</span></span>)</span><br/>           <span class="paren1">(<span class=""><span class="keyword">:p</span> <span class="paren2">(<span class=""><span class="keyword">:a</span> <span class="keyword">:href</span> <span class="string">"/show-cookies"</span> <span class="string">"Look at cookie jar."</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span><br/><br/><span class="paren1">(<span class="">publish <span class="keyword">:path</span> <span class="string">"/set-cookie"</span> <span class="keyword">:function</span> 'set-cookie</span>)</span><br/></pre>

<p>Если вы откроете в браузере <code><a href="http://localhost:2001/set-cookie">http://localhost:2001/set-cookie</a></code>, он должен отобразить страницу, показанную на рисунке 26-8. Вдобавок сервер пошлет заголовок <code>Set-Cookie</code> с cookie по имени "MyCookie" со значением "A cookie value". Если вы нажмете на ссылку <em>Look at cookie jar</em>, вы попадете на страницу <code>/show-cookies</code>, где увидите новый cookie, как показано на рисунке 26-9. Так как вы не задали аргумент <code>:expires</code>, браузер продолжит посылать cookie при каждом запросе пока вы не выйдете из него.
</p>
<p>Рисунок 26-8. <a href="http://localhost:2001/set-cookie">http://localhost:2001/set-cookie</a>
</p>
<p>Рисунок 26-9. <a href="http://localhost:2001/show-cookies">http://localhost:2001/show-cookies</a> после установки cookie
</p>



</div><div class="chapter" id="&#x41D;&#x435;&#x431;&#x43E;&#x43B;&#x44C;&#x448;&#x43E;&#x439; &#x43A;&#x430;&#x440;&#x43A;&#x430;&#x441; &#x43F;&#x440;&#x438;&#x43B;&#x43E;&#x436;&#x435;&#x43D;&#x438;&#x439;"><h3>Небольшой каркас приложений</h3>

<p>Хотя AllegroServe предоставляет достаточно прямой доступ ко всем базовым возможностям, необходимым для написания кода, выполняющегося на стороне сервера (доступ к параметрам запроса как из строки запроса, таки и из POST-данных; возможность установки cookie и получения их значений; и, конечно же, возможность генерирования ответа для посылки браузеру), приходится писать некоторое количество раздражающе повторяющегося кода.
</p>
<p>Например, каждая генерирующая HTML функция, которую вы будете писать, будет получать в качестве аргументов запрос и сущность, а затем будет содержать вызовы <code>with-http-response</code>, <code>with-http-body</code> и, если вы будете использовать <code>FOO</code> для генерирования HTML, <code>with-html-output</code>. Далее, функции, которым нужно получать параметры запроса, будут содержать множество вызовов <code>request-query-value</code> и еще больше кода для преобразования получаемых строк к нужным типам. И наконец вам нужно не забыть опубликовать функции.
</p>
<p>Для уменьшения повторяющегося кода, который вам нужно писать, мы можем раализовать небольшой каркас поверх AllegroServe в целях облегчения определения функций, обрабатывающих запросы по определенным URL.
</p>
<p>Базовым приближением будет определение макроса <code>define-url-function</code>, которыймы будем использовать для определения функций, которые будут автоматически публиковаться с помощью <code>publish</code>. Этот макрос будет раскрываться в <strong>DEFUN</strong>, содержащий соответствующий шаблонный код, а также в код публикации функции под URL с таким же, как у функции, именем. Он также возьмет на себя заботу по генерации кода извлечения значений параметров запроса и cookies и связывания их с переменными, объявленными в списке параметров функции. Таким образом, базовой формой определения <code>define-url-function</code> будет такая:
</p>
<pre class="code"><span class="paren1">(<span class=""><i><span class="symbol">define-url-function</span></i> name <span class="paren2">(<span class="">request query-parameter*</span>)</span><br/>  body</span>)</span><br/></pre>

<p>где <code>body</code> будет кодом, выдающим код HTML страницы. Он будет обернут в вызов макроса <code>html</code> из <code>FOO</code>, и поэтому для простых страниц может не содержать ничего, кроме представляющего HTML s-выражения.
</p>
<p>Внутри тела переменные параметров запроса будут связаны со значениями параметров запроса с такими же именами или значениями cookie. В простейшем случае значением параметра запроса будет строка, полученная из параметра запроса или поля POST-данных с таким же именем. Если же параметр запроса задается списком, вы также можете задать автоматическое преобразование типа, значение по умолчанию, и то, нужно ли получать значение параметра из и сохранять его в cookie. Полный синтаксис для параметра запроса выглядит так:
</p><pre>name | (name type [default-value] [stickiness])<br/></pre>
<p><code>type</code> должен быть именем, распознаваемым <code>define-url-function</code>. Мы скоро обсудим как определять новые типы. <code>default-value</code> должно быть значением данного типа. И, наконец, <code>stickness</code>, если предоставлен, указывает, что значение параметра должно быть взято из cookie с соответствующим именем в случае, если параметр запроса не предоставлен, а также что в ответе должен быть послан заголовок <code>Set-Cookie</code>, который сохранит значение cookie с этим именем. Таким образом, сохраняемый параметр (sticky parameter), после явного предоставления значения в параметре запроса, сохранит это значение при последующих запросах страницы даже если параметр запроса не предоставляется.
</p>
<p>Имя используемого cookie зависит от значения <code>stickness</code>: при значении <code>:global</code> cookie будет иметь то же имя, что и параметр. Таким образом, различные функции, использующие глобальные сохраняемые параметры с одинаковым именем, будут разделять значение. Если <code>stickness</code> равно <code>:package</code>, то имя cookie будет сконструировано из имен параметра и пакета, в котором находится имя функции; это позволит функциям одного пакета разделять значения не заботясь о возможных конфликтах с парметрами функций других пакетов. И, наконец, параметр со значением <code>stickness</code> равным <code>:local</code> будет использовать имя cookie, составленное из имен параметра, пакета, в котором находится имя функции, и самого имени функции, что делает его уникальным для этой функции.
</p>
<p>Например, вы можете использовать <code>define-url-function</code> для замены предыдущего 11-строчного определения <code>random-page</code> 5-строчной версией:
</p>
<pre class="code"><span class="paren1">(<span class=""><i><span class="symbol">define-url-function</span></i> random-number <span class="paren2">(<span class="">request <span class="paren3">(<span class="">limit <a href="http://www.lispworks.com/reference/HyperSpec/Body/t_intege.htm" class="symbol">integer</a> 1000</span>)</span></span>)</span><br/>  <span class="paren2">(<span class=""><span class="keyword">:html</span><br/>    <span class="paren3">(<span class=""><span class="keyword">:head</span> <span class="paren4">(<span class=""><span class="keyword">:title</span> <span class="string">"Random"</span></span>)</span></span>)</span><br/>    <span class="paren3">(<span class=""><span class="keyword">:body</span><br/>      <span class="paren4">(<span class=""><span class="keyword">:p</span> <span class="string">"Random number: "</span> <span class="paren5">(<span class=""><span class="keyword">:print</span> <span class="paren6">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_random.htm" class="symbol">random</a> limit</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span><br/></pre>

<p>Если вы хотите, чтобы аргумент <code>limit</code> сохранялся, вы должны изменить объявление <code>limit</code> следующим образом: <code>(limit integer 1000 :local)</code>.
</p>



</div><div class="chapter" id="&#x420;&#x435;&#x430;&#x43B;&#x438;&#x437;&#x430;&#x446;&#x438;&#x44F;"><h3>Реализация</h3>

<p>Я разъясню реализацию <code>define-url-function</code> "сверху вниз". Сам макрос выглядит следующим образом:
</p>
<pre class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defmac.htm" class="symbol"><i><span class="symbol">defmacro</span></i></a> <i><span class="symbol">define-url-function</span></i> <span class="paren2">(<span class="">name <span class="paren3">(<span class="">request &amp;rest params</span>)</span> &amp;body body</span>)</span><br/>  <span class="paren2">(<span class=""><i><span class="symbol">with-gensyms</span></i> <span class="paren3">(<span class="">entity</span>)</span><br/>    <span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_let_l.htm" class="symbol"><i><span class="symbol">let</span></i></a> <span class="paren4">(<span class=""><span class="paren5">(<span class="">params <span class="paren6">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_mapc_.htm" class="symbol">mapcar</a> #'normalize-param params</span>)</span></span>)</span></span>)</span><br/>      `<span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_progn.htm" class="symbol"><i><span class="symbol">progn</span></i></a><br/>         <span class="paren5">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defun.htm" class="symbol"><i><span class="symbol">defun</span></i></a> ,name <span class="paren6">(<span class="">,request ,entity</span>)</span><br/>           <span class="paren6">(<span class=""><i><span class="symbol">with-http-response</span></i> <span class="paren1">(<span class="">,request ,entity <span class="keyword">:content-type</span> <span class="string">"text/html"</span></span>)</span><br/>             <span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_let_l.htm" class="symbol"><i><span class="symbol">let*</span></i></a> <span class="paren2">(<span class="">,@<span class="paren3">(<span class="">param-bindings name request params</span>)</span></span>)</span><br/>               ,@<span class="paren2">(<span class="">set-cookies-code name request params</span>)</span><br/>               <span class="paren2">(<span class=""><i><span class="symbol">with-http-body</span></i> <span class="paren3">(<span class="">,request ,entity</span>)</span><br/>                 <span class="paren3">(<span class=""><i><span class="symbol">with-html-output</span></i> <span class="paren4">(<span class=""><span class="paren5">(<span class="">request-reply-stream ,request</span>)</span></span>)</span><br/>                   <span class="paren4">(<span class="">html ,@body</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span><br/>         <span class="paren5">(<span class="">publish <span class="keyword">:path</span> ,<span class="paren6">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_format.htm" class="symbol">format</a> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_nil.htm" class="symbol">nil</a> <span class="string">"/~(~a~)"</span> name</span>)</span> <span class="keyword">:function</span> ',name</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span><br/></pre>

<p>Давайте рассмотрим ее по шагам, начиная с первых строк.
</p>
<pre class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defmac.htm" class="symbol"><i><span class="symbol">defmacro</span></i></a> <i><span class="symbol">define-url-function</span></i> <span class="paren2">(<span class="">name <span class="paren3">(<span class="">request &amp;rest params</span>)</span> &amp;body body</span>)</span><br/>  <span class="paren2">(<span class=""><i><span class="symbol">with-gensyms</span></i> <span class="paren3">(<span class="">entity</span>)</span><br/>    <span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_let_l.htm" class="symbol"><i><span class="symbol">let</span></i></a> <span class="paren4">(<span class=""><span class="paren5">(<span class="">params <span class="paren6">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_mapc_.htm" class="symbol">mapcar</a> #'normalize-param params</span>)</span></span>)</span></span>)</span><br/></span></span></span></span></span></span></pre>

<p>Up to here you're just getting ready to generate code. Мы генерируем с помощью <strong>GENSYM</strong> символ для дальнейшего использования в качестве имени параметра сущности в <strong>DEFUN</strong>. Затем мы нормализуем параметры, преобразуя обычные символы в списочную форму с помощью следующей функции:
</p>
<pre class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defun.htm" class="symbol"><i><span class="symbol">defun</span></i></a> normalize-param <span class="paren2">(<span class="">param</span>)</span><br/>  <span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_tpcase.htm" class="symbol">etypecase</a> param<br/>    <span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_list.htm" class="symbol">list</a> param</span>)</span><br/>    <span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/t_symbol.htm" class="symbol">symbol</a> `<span class="paren4">(<span class="">,param <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_string.htm" class="symbol">string</a> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_nil.htm" class="symbol">nil</a> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_nil.htm" class="symbol">nil</a></span>)</span></span>)</span></span>)</span></span>)</span><br/></pre>

<p>Другими словами, объявления параметра как просто символа — это тоже самое, что и объявление несохраняемого строкового параметра без значения по умолчанию.
</p>
<p>Затем идет <strong>PROGN</strong>. Мы должны раскрывать макрос в <strong>PROGN</strong> так как нам нужно сгенерировать код, осуществляющий две вещи: определение функции с помощью <strong>DEFUN</strong> и вызов <code>publish</code>. Определение функции должно идти первым: таким образом, если в ее определении будет ошибка, то функция не будет опубликована. Первые две строки <strong>DEFUN</strong> являются уже привычным нам шаблонным кодом:
</p>
<pre class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defun.htm" class="symbol"><i><span class="symbol">defun</span></i></a> ,name <span class="paren2">(<span class="">,request ,entity</span>)</span><br/>  <span class="paren2">(<span class=""><i><span class="symbol">with-http-response</span></i> <span class="paren3">(<span class="">,request ,entity <span class="keyword">:content-type</span> <span class="string">"text/html"</span></span>)</span>  <br/></span></span></span></span></pre>

<p>Теперь мы можем приступить к настоящей работе. Следующие две строки генерируют привязки параметров, заданных в <code>define-url-function</code> (кроме <code>request</code>), а также код, вызывающий <code>set-cookie-header</code> для сохраняемых параметров. Конечно же реальная работа осуществляется во вспомогательных функциях, которые мы вскоре увидим<a class="fn_top" id="fnt__12" href="practical-web-programming-with-allegroserve#fn__12">12)</a>.
</p>
<pre class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_let_l.htm" class="symbol"><i><span class="symbol">let*</span></i></a> <span class="paren2">(<span class="">,@<span class="paren3">(<span class="">param-bindings name request params</span>)</span></span>)</span><br/>  ,@<span class="paren2">(<span class="">set-cookies-code name request params</span>)</span><br/></span></span></pre>

<p>Оставшаяся часть кода более шаблонна: мы помещаем тело из определения <code>define-url-function</code> в соответствующий контекст <code>with-http-body</code>, <code>with-html-output</code> и макроса <code>html</code>. Затем идет вызов <code>publish</code>.
</p>
<pre class="code"><span class="paren1">(<span class="">publish <span class="keyword">:path</span> ,<span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_format.htm" class="symbol">format</a> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_nil.htm" class="symbol">nil</a> <span class="string">"/~(~a~)"</span> name</span>)</span> <span class="keyword">:function</span> ',name</span>)</span><br/></pre>

<p>Выражение <code>(format nil "/~(~a~)" name)</code> вычисляется во время раскрытия макросов, генерируя строку, состоящую из <code>/</code>, за которым следует преобразованное к нижнему регистру имя функции, почти определенной нами. Эта строка становится аргументом <code>:path</code> функции <code>publish</code>, а имя функции – аргументом <code>:function</code>.
</p>
<p>Теперь давайте взглянем на вспомогательные функции, используемые при генерировании формы <strong>DEFUN</strong>. Для генерирования привязок параметров нам нужно пройтись по параметрам и собрать код, сгенерированный <code>param-binding</code> для каждого из них. Такой код для каждого параметра будет списком, содержащим имя связываемой переменной и код, который вычисляет ее значение. Точный код для вычисления значения будет зависеть от типа параметра, того, является ли он сохраняемым, и от наличия значения по умолчанию. Так как мы уже нормализовали параметры, мы можем использовать <strong>DESTRUCTURING-BIND</strong> для их разбора в <code>param-binding</code>.
</p>
<pre class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defun.htm" class="symbol"><i><span class="symbol">defun</span></i></a> param-bindings <span class="paren2">(<span class="">function-name request params</span>)</span><br/>  <span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_loop.htm" class="symbol"><i><span class="symbol">loop</span></i></a> for param in params<br/>     collect <span class="paren3">(<span class="">param-binding function-name request param</span>)</span></span>)</span></span>)</span><br/><br/><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defun.htm" class="symbol"><i><span class="symbol">defun</span></i></a> param-binding <span class="paren2">(<span class="">function-name request param</span>)</span><br/>  <span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_destru.htm" class="symbol">destructuring-bind</a> <span class="paren3">(<span class="">name <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_type.htm" class="symbol">type</a> &amp;optional <i><span class="symbol">default</span></i> sticky</span>)</span> param<br/>    <span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_let_l.htm" class="symbol"><i><span class="symbol">let</span></i></a> <span class="paren4">(<span class=""><span class="paren5">(<span class="">query-name <span class="paren6">(<span class="">symbol-&gt;query-name name</span>)</span></span>)</span><br/>          <span class="paren5">(<span class="">cookie-name <span class="paren6">(<span class="">symbol-&gt;cookie-name function-name name sticky</span>)</span></span>)</span></span>)</span><br/>      `<span class="paren4">(<span class="">,name <span class="paren5">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_or.htm" class="symbol">or</a> <br/>               <span class="paren6">(<span class="">string-&gt;type ',<a href="http://www.lispworks.com/reference/HyperSpec/Body/a_type.htm" class="symbol">type</a> <span class="paren1">(<span class="">request-query-value ,query-name ,request</span>)</span></span>)</span><br/>               ,@<span class="paren6">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_if.htm" class="symbol"><i><span class="symbol">if</span></i></a> cookie-name<br/>                     <span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_list.htm" class="symbol">list</a> `<span class="paren2">(<span class="">string-&gt;type ',<a href="http://www.lispworks.com/reference/HyperSpec/Body/a_type.htm" class="symbol">type</a> <span class="paren3">(<span class="">get-cookie-value ,request ,cookie-name</span>)</span></span>)</span></span>)</span></span>)</span><br/>               ,<i><span class="symbol">default</span></i></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span><br/></pre>

<p>Функция <code>string-&gt;type</code>, используемая для преобразования к желаемым типам полученных из параметров запроса и cookies строк, является обобщенной функцией со следующей сигнатурой:
</p>
<pre class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defgen.htm" class="symbol"><i><span class="symbol">defgeneric</span></i></a> string-&gt;type <span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_type.htm" class="symbol">type</a> value</span>)</span></span>)</span><br/></pre>

<p>Для того, чтобы иметь возможность использования определенного имени в качестве имени типа параметра запроса, нам нужно просто определить метод <code>string-&gt;type</code>. Нам нужно определить по меньшей мере метод, специализированный по строковому типу, так как это тип по умолчанию. Конечно же это очень просто. Так как браузеры порой посылают формы с пустыми строками для индикации отсутствия значения, нам нужно преобразовывать пустые строки в <strong>NIL</strong>, как и делает следующий метод:
</p>
<pre class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defmet.htm" class="symbol"><i><span class="symbol">defmethod</span></i></a> string-&gt;type <span class="paren2">(<span class=""><span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_type.htm" class="symbol">type</a> <span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_eql.htm" class="symbol">eql</a> '<a href="http://www.lispworks.com/reference/HyperSpec/Body/a_string.htm" class="symbol">string</a></span>)</span></span>)</span> value</span>)</span><br/>  <span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_and.htm" class="symbol">and</a> <span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_minusp.htm" class="symbol">plusp</a> <span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_length.htm" class="symbol">length</a> value</span>)</span></span>)</span> value</span>)</span></span>)</span><br/></pre>

<p>Мы можем добавить преобразования для других типов, нужных нашему приложению. Например, чтобы иметь возможность использования в качестве типа параметров запроса <code>integer</code>, а следовательно возможность обработки параметра <code>limit</code> функции <code>random-page</code>, мы можем определить следующий метод:
</p>
<pre class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defmet.htm" class="symbol"><i><span class="symbol">defmethod</span></i></a> string-&gt;type <span class="paren2">(<span class=""><span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_type.htm" class="symbol">type</a> <span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_eql.htm" class="symbol">eql</a> '<a href="http://www.lispworks.com/reference/HyperSpec/Body/t_intege.htm" class="symbol">integer</a></span>)</span></span>)</span> value</span>)</span><br/>  <span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_parse_.htm" class="symbol">parse-integer</a> <span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_or.htm" class="symbol">or</a> value <span class="string">""</span></span>)</span> <span class="keyword">:junk-allowed</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_t.htm" class="symbol">t</a></span>)</span></span>)</span><br/></pre>

<p>Еще одной вспомогательной функцией, используемой кодом, генерируемым <code>param-binding</code>, является <code>get-cookie-value</code>, которая является небольшим синтаксическим сахаром вокруг функции <code>get-cookie-values</code>, предоставляемой AllegroServe. Она выглядит следующим образом:
</p>
<pre class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defun.htm" class="symbol"><i><span class="symbol">defun</span></i></a> get-cookie-value <span class="paren2">(<span class="">request name</span>)</span><br/>  <span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_car_c.htm" class="symbol">cdr</a> <span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_assocc.htm" class="symbol">assoc</a> name <span class="paren4">(<span class="">get-cookie-values request</span>)</span> <span class="keyword">:test</span> #'<a href="http://www.lispworks.com/reference/HyperSpec/Body/f_stgeq_.htm" class="symbol">string=</a></span>)</span></span>)</span></span>)</span><br/></pre>

<p>Функции, вычисляющие имена параметров запроса и cookies, довольно прямолинейны:
</p>
<pre class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defun.htm" class="symbol"><i><span class="symbol">defun</span></i></a> symbol-&gt;query-name <span class="paren2">(<span class="">sym</span>)</span><br/>  <span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_stg_up.htm" class="symbol">string-downcase</a> sym</span>)</span></span>)</span><br/><br/><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defun.htm" class="symbol"><i><span class="symbol">defun</span></i></a> symbol-&gt;cookie-name <span class="paren2">(<span class="">function-name sym sticky</span>)</span><br/>  <span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_let_l.htm" class="symbol"><i><span class="symbol">let</span></i></a> <span class="paren3">(<span class=""><span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_pkg_na.htm" class="symbol">package-name</a> <span class="paren5">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_pkg_na.htm" class="symbol">package-name</a> <span class="paren6">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_symb_3.htm" class="symbol">symbol-package</a> function-name</span>)</span></span>)</span></span>)</span></span>)</span><br/>    <span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_when_.htm" class="symbol">when</a> sticky<br/>      <span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_case_.htm" class="symbol">ecase</a> sticky<br/>        <span class="paren5">(<span class=""><span class="keyword">:global</span><br/>         <span class="paren6">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_stg_up.htm" class="symbol">string-downcase</a> sym</span>)</span></span>)</span><br/>        <span class="paren5">(<span class=""><span class="keyword">:package</span><br/>         <span class="paren6">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_format.htm" class="symbol">format</a> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_nil.htm" class="symbol">nil</a> <span class="string">"~(~a:~a~)"</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/f_pkg_na.htm" class="symbol">package-name</a> sym</span>)</span></span>)</span><br/>        <span class="paren5">(<span class=""><span class="keyword">:local</span> <br/>         <span class="paren6">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_format.htm" class="symbol">format</a> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_nil.htm" class="symbol">nil</a> <span class="string">"~(~a:~a:~a~)"</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/f_pkg_na.htm" class="symbol">package-name</a> function-name sym</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span><br/></pre>

<p>Для генерирования кода, устанавливающего cookies для сохраняемых параметров, нам снова нужно пройтись по списку парметров, на этот раз собирая код для каждого сохранямого параметра. Мы можем использовать формы <strong>LOOP</strong> <code>when</code> и <code>collect it</code> для собирания только не-<strong>NIL</strong> значений, возвращенных <code>set-cookie-code</code>.
</p>
<pre class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defun.htm" class="symbol"><i><span class="symbol">defun</span></i></a> set-cookies-code <span class="paren2">(<span class="">function-name request params</span>)</span><br/>  <span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_loop.htm" class="symbol"><i><span class="symbol">loop</span></i></a> for param in params<br/>       <a href="http://www.lispworks.com/reference/HyperSpec/Body/m_when_.htm" class="symbol">when</a> <span class="paren3">(<span class="">set-cookie-code function-name request param</span>)</span> collect it</span>)</span></span>)</span><br/><br/><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defun.htm" class="symbol"><i><span class="symbol">defun</span></i></a> set-cookie-code <span class="paren2">(<span class="">function-name request param</span>)</span><br/>  <span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_destru.htm" class="symbol">destructuring-bind</a> <span class="paren3">(<span class="">name <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_type.htm" class="symbol">type</a> &amp;optional <i><span class="symbol">default</span></i> sticky</span>)</span> param<br/>    <span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_declar.htm" class="symbol">declare</a> <span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/d_ignore.htm" class="symbol">ignore</a> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_type.htm" class="symbol">type</a> <i><span class="symbol">default</span></i></span>)</span></span>)</span><br/>    <span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_if.htm" class="symbol"><i><span class="symbol">if</span></i></a> sticky<br/>      `<span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_when_.htm" class="symbol">when</a> ,name <br/>         <span class="paren5">(<span class="">set-cookie-header <br/>          ,request<br/>          <span class="keyword">:name</span> ,<span class="paren6">(<span class="">symbol-&gt;cookie-name function-name name sticky</span>)</span><br/>          <span class="keyword">:value</span> <span class="paren6">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_wr_to_.htm" class="symbol">princ-to-string</a> ,name</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span><br/></pre>

<p>Одним из преимуществ определения макросов в терминах вспомогательных функций, как здесь, является то, что так легко удостовериваться, что отдельные части генерируемого кода выглядят правильно. Например, вы можете проверить, что такой вызов <code>set-cookie-code</code>:
</p>
<pre class="code"><span class="paren1">(<span class="">set-cookie-code 'foo 'request '<span class="paren2">(<span class="">x <a href="http://www.lispworks.com/reference/HyperSpec/Body/t_intege.htm" class="symbol">integer</a> 20 <span class="keyword">:local</span></span>)</span></span>)</span><br/></pre>

<p>генерирует такой код:
</p>
<pre class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_when_.htm" class="symbol">WHEN</a> X<br/>  <span class="paren2">(<span class="">SET-COOKIE-HEADER REQUEST<br/>    <span class="keyword">:NAME</span> <span class="string">"com.gigamonkeys.web:foo:x"</span><br/>    <span class="keyword">:VALUE</span> <span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_wr_to_.htm" class="symbol">PRINC-TO-STRING</a> X</span>)</span></span>)</span></span>)</span><br/></pre>

<p>Подразумевая, что этот код находится в контексте, в котором <code>x</code> является именем переменной, все выглядит хорошо.
</p>
<p>И еще раз, макросы позволяют нам свести код, которые необходимо писать, к его сути: в нашем случае это данные, которые нам нужно извлечь из запроса, и HTML, который мы хотим сгенерировать. Этот каркас не претендует на то, чтобы являться наивысшим достижением в области создания каркасов построения web-приложений, — он является просто небольшим синтаксическим сахаром, немного упрощающим написание простых приложений, наподобие такого, что мы напишем в главе 29.
</p>
<p>Но перед тем, как приступить к этому, нам нужно написать "внутренности" приложения, для которых приложение, которое мы напишем в главе 29, будет пользовательским интерфейсом. Мы начнем в следующей главе с написания улучшенной версии базы данных, написанной нами ранее в главе 3, которую мы будем использовать для хранения данных ID3, извлеченных из файлов MP3.
</p>
</div></div><div class="footnotes"><div><a class="fn_bot" id="fn__1" href="practical-web-programming-with-allegroserve#fnt__1">1)</a>Новичкам в Web-программировании вероятно понадобится дополнить это введение информацией из одного-двух учебников с более глубоким охватом. Вы можете найти хорошую подборку доступных online учебников по адресу <a href="http://www.jmarshall.com/easy/.">http://www.jmarshall.com/easy/.</a></div><div><a class="fn_bot" id="fn__2" href="practical-web-programming-with-allegroserve#fnt__2">2)</a>Загрузка отдельной Web-страницы может привести к выполнению множества запросов – для отображения HTML-страницы, содержащей изображения, браузер должен выполнить отдельный запрос для каждого из них, а затем вставить их на соответствующие места страницы.</div><div><a class="fn_bot" id="fn__3" href="practical-web-programming-with-allegroserve#fnt__3">3)</a>Большая часть сложности Web-программирования заключается в попытках обойти это основное ограничение, чтобы предоставить пользователю больше возможностей, таких как интерактивность приложений, выполняющихся на компьютере пользователей.</div><div><a class="fn_bot" id="fn__4" href="practical-web-programming-with-allegroserve#fnt__4">4)</a>К сожалению, слово <em>динамичный</em> (<em>dynamic</em>) имеет много значений в мире Web. Фраза "динамичный HTML" (<em>Dynamic HTML</em>) относится к HTML, который содержит встроенный код, обычно на языке JavaScript, который может выполняться браузером без дополнительного общения с сервером. При осторожном использовании, динамичный HTML может улучшить работу Web-приложения, поскольку, даже при использовании высокоскоростных соединений, выполнение запроса к серверу, получение результата, и отображение новой страницы может занять заметное количество времени. Что еще более запутывает дело, динамически генерируемые страницы (страницы генерируемые на сервере) могут также содержать динамичный HTML (код для выполнения на клиенте). В этой книге мы столкнемся только с динамически генерируемым обычным, не динамичным HTML.</div><div><a class="fn_bot" id="fn__5" href="practical-web-programming-with-allegroserve#fnt__5">5)</a><a href="http://www.fractalconcept.com/asp/html/mod">http://www.fractalconcept.com/asp/html/mod</a>_lisp.html</div><div><a class="fn_bot" id="fn__6" href="practical-web-programming-with-allegroserve#fnt__6">6)</a><a href="http://lisplets.sourceforge.net/">http://lisplets.sourceforge.net/</a></div><div><a class="fn_bot" id="fn__7" href="practical-web-programming-with-allegroserve#fnt__7">7)</a>AllegroServe также предоставляет каркас (framework), названный <em>Webactions</em>, который аналогичен JSP в Java — вместо написания кода, который генерирует HTML, с помощью Webactions вы можете писать страницы, которые являются HTML, но с небольшим количеством специального кода, разворачивающегося в настоящий код при обработке страницы. В этой книге я не буду описывать Webactions.</div><div><a class="fn_bot" id="fn__8" href="practical-web-programming-with-allegroserve#fnt__8">8)</a>Загрузка PortableAllegroServe также создаст дополнительные пакеты для библиотек, обеспечивающих совместимость, но нас в основном интересуют три вышеперечисленных пакета.</div><div><a class="fn_bot" id="fn__9" href="practical-web-programming-with-allegroserve#fnt__9">9)</a>Спецификатор <code>~@</code>, за которым следует знак новой строки, заставляет <strong>FORMAT</strong> игнорировать пробельные знаки после этого знака новой строки, что позволяет вам красиво отформатировать код без фактического добавления пробельных знаков в HTML. Поскольку пробельные знаки обычно не являются значимыми в HTML, это никак не влияет не работу браузера, но делает сгенерированный код HTML более удобным для чтения людьми.</div><div><a class="fn_bot" id="fn__10" href="practical-web-programming-with-allegroserve#fnt__10">10)</a><code>FOO</code> – это рекурсивный тавтологический акроним для "FOO Outputs Output".</div><div><a class="fn_bot" id="fn__11" href="practical-web-programming-with-allegroserve#fnt__11">11)</a>За информацией о смысле остальных параметров обращайтесь к документации AllegroServe и RFC 2109, разъясняющей механизм cookie.</div><div><a class="fn_bot" id="fn__12" href="practical-web-programming-with-allegroserve#fnt__12">12)</a>Нам нужно использовать <strong>LET* </strong> вместо <strong>LET</strong>, чтобы позволить формам значений параметров по умолчанию ссылаться на параметры, идущие в списке ранее. Например, вы можете написать такое:

<pre class="code"><span class="paren1">(<span class=""><i><span class="symbol">define-url-function</span></i> <span class="paren2">(<span class="">request <span class="paren3">(<span class="">x <a href="http://www.lispworks.com/reference/HyperSpec/Body/t_intege.htm" class="symbol">integer</a> 10</span>)</span> <span class="paren3">(<span class="">y <a href="http://www.lispworks.com/reference/HyperSpec/Body/t_intege.htm" class="symbol">integer</a> <span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_st.htm" class="symbol">*</a> 2 x</span>)</span></span>)</span></span>)</span> ...</span>)</span><br/></pre>

и значение <code>y</code>, не будучи предоставлено, будет удвоенным значением <code>x</code>.</div></div></div> <table width="100%"> <tbody> <tr> <td width="20%" align="left"> <a href="practical-an-id3-parser">Предыдущая</a> </td> <td width="60%" align="center"> <a href="index.html">Оглавление</a> </td> <td width="20%" align="right"> <a href="practical-an-mp3-database">Следующая</a> </td> </tr> </tbody> </table> </div> <div class="bottom">@2009-2013 lisper.ru</div> 
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-7734690-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
 </body> </html>